(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):(global=typeof globalThis!=="undefined"?globalThis:global||self,global.OPL3=factory())})(this,function(){"use strict";function getAugmentedNamespace(n){var f=n.default;if(typeof f=="function"){var a=function(){return f.apply(this,arguments)};a.prototype=f.prototype}else a={};Object.defineProperty(a,"__esModule",{value:true});Object.keys(n).forEach(function(k){var d=Object.getOwnPropertyDescriptor(n,k);Object.defineProperty(a,k,d.get?d:{enumerable:true,get:function(){return n[k]}})});return a}function _regeneratorRuntime(){_regeneratorRuntime=function(){return exports};var exports={},Op=Object.prototype,hasOwn=Op.hasOwnProperty,defineProperty=Object.defineProperty||function(obj,key,desc){obj[key]=desc.value},$Symbol="function"==typeof Symbol?Symbol:{},iteratorSymbol=$Symbol.iterator||"@@iterator",asyncIteratorSymbol=$Symbol.asyncIterator||"@@asyncIterator",toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag";function define(obj,key,value){return Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}),obj[key]}try{define({},"")}catch(err){define=function(obj,key,value){return obj[key]=value}}function wrap(innerFn,outerFn,self,tryLocsList){var protoGenerator=outerFn&&outerFn.prototype instanceof Generator?outerFn:Generator,generator=Object.create(protoGenerator.prototype),context=new Context(tryLocsList||[]);return defineProperty(generator,"_invoke",{value:makeInvokeMethod(innerFn,self,context)}),generator}function tryCatch(fn,obj,arg){try{return{type:"normal",arg:fn.call(obj,arg)}}catch(err){return{type:"throw",arg:err}}}exports.wrap=wrap;var ContinueSentinel={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var IteratorPrototype={};define(IteratorPrototype,iteratorSymbol,function(){return this});var getProto=Object.getPrototypeOf,NativeIteratorPrototype=getProto&&getProto(getProto(values([])));NativeIteratorPrototype&&NativeIteratorPrototype!==Op&&hasOwn.call(NativeIteratorPrototype,iteratorSymbol)&&(IteratorPrototype=NativeIteratorPrototype);var Gp=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(IteratorPrototype);function defineIteratorMethods(prototype){["next","throw","return"].forEach(function(method){define(prototype,method,function(arg){return this._invoke(method,arg)})})}function AsyncIterator(generator,PromiseImpl){function invoke(method,arg,resolve,reject){var record=tryCatch(generator[method],generator,arg);if("throw"!==record.type){var result=record.arg,value=result.value;return value&&"object"==typeof value&&hasOwn.call(value,"__await")?PromiseImpl.resolve(value.__await).then(function(value){invoke("next",value,resolve,reject)},function(err){invoke("throw",err,resolve,reject)}):PromiseImpl.resolve(value).then(function(unwrapped){result.value=unwrapped,resolve(result)},function(error){return invoke("throw",error,resolve,reject)})}reject(record.arg)}var previousPromise;defineProperty(this,"_invoke",{value:function(method,arg){function callInvokeWithMethodAndArg(){return new PromiseImpl(function(resolve,reject){invoke(method,arg,resolve,reject)})}return previousPromise=previousPromise?previousPromise.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(innerFn,self,context){var state="suspendedStart";return function(method,arg){if("executing"===state)throw new Error("Generator is already running");if("completed"===state){if("throw"===method)throw arg;return doneResult()}for(context.method=method,context.arg=arg;;){var delegate=context.delegate;if(delegate){var delegateResult=maybeInvokeDelegate(delegate,context);if(delegateResult){if(delegateResult===ContinueSentinel)continue;return delegateResult}}if("next"===context.method)context.sent=context._sent=context.arg;else if("throw"===context.method){if("suspendedStart"===state)throw state="completed",context.arg;context.dispatchException(context.arg)}else"return"===context.method&&context.abrupt("return",context.arg);state="executing";var record=tryCatch(innerFn,self,context);if("normal"===record.type){if(state=context.done?"completed":"suspendedYield",record.arg===ContinueSentinel)continue;return{value:record.arg,done:context.done}}"throw"===record.type&&(state="completed",context.method="throw",context.arg=record.arg)}}}function maybeInvokeDelegate(delegate,context){var method=delegate.iterator[context.method];if(undefined===method){if(context.delegate=null,"throw"===context.method){if(delegate.iterator.return&&(context.method="return",context.arg=undefined,maybeInvokeDelegate(delegate,context),"throw"===context.method))return ContinueSentinel;context.method="throw",context.arg=new TypeError("The iterator does not provide a 'throw' method")}return ContinueSentinel}var record=tryCatch(method,delegate.iterator,context.arg);if("throw"===record.type)return context.method="throw",context.arg=record.arg,context.delegate=null,ContinueSentinel;var info=record.arg;return info?info.done?(context[delegate.resultName]=info.value,context.next=delegate.nextLoc,"return"!==context.method&&(context.method="next",context.arg=undefined),context.delegate=null,ContinueSentinel):info:(context.method="throw",context.arg=new TypeError("iterator result is not an object"),context.delegate=null,ContinueSentinel)}function pushTryEntry(locs){var entry={tryLoc:locs[0]};1 in locs&&(entry.catchLoc=locs[1]),2 in locs&&(entry.finallyLoc=locs[2],entry.afterLoc=locs[3]),this.tryEntries.push(entry)}function resetTryEntry(entry){var record=entry.completion||{};record.type="normal",delete record.arg,entry.completion=record}function Context(tryLocsList){this.tryEntries=[{tryLoc:"root"}],tryLocsList.forEach(pushTryEntry,this),this.reset(!0)}function values(iterable){if(iterable){var iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod)return iteratorMethod.call(iterable);if("function"==typeof iterable.next)return iterable;if(!isNaN(iterable.length)){var i=-1,next=function next(){for(;++i<iterable.length;)if(hasOwn.call(iterable,i))return next.value=iterable[i],next.done=!1,next;return next.value=undefined,next.done=!0,next};return next.next=next}}return{next:doneResult}}function doneResult(){return{value:undefined,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,defineProperty(Gp,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),defineProperty(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,toStringTagSymbol,"GeneratorFunction"),exports.isGeneratorFunction=function(genFun){var ctor="function"==typeof genFun&&genFun.constructor;return!!ctor&&(ctor===GeneratorFunction||"GeneratorFunction"===(ctor.displayName||ctor.name))},exports.mark=function(genFun){return Object.setPrototypeOf?Object.setPrototypeOf(genFun,GeneratorFunctionPrototype):(genFun.__proto__=GeneratorFunctionPrototype,define(genFun,toStringTagSymbol,"GeneratorFunction")),genFun.prototype=Object.create(Gp),genFun},exports.awrap=function(arg){return{__await:arg}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,asyncIteratorSymbol,function(){return this}),exports.AsyncIterator=AsyncIterator,exports.async=function(innerFn,outerFn,self,tryLocsList,PromiseImpl){void 0===PromiseImpl&&(PromiseImpl=Promise);var iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList),PromiseImpl);return exports.isGeneratorFunction(outerFn)?iter:iter.next().then(function(result){return result.done?result.value:iter.next()})},defineIteratorMethods(Gp),define(Gp,toStringTagSymbol,"Generator"),define(Gp,iteratorSymbol,function(){return this}),define(Gp,"toString",function(){return"[object Generator]"}),exports.keys=function(val){var object=Object(val),keys=[];for(var key in object)keys.push(key);return keys.reverse(),function next(){for(;keys.length;){var key=keys.pop();if(key in object)return next.value=key,next.done=!1,next}return next.done=!0,next}},exports.values=values,Context.prototype={constructor:Context,reset:function(skipTempReset){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(resetTryEntry),!skipTempReset)for(var name in this)"t"===name.charAt(0)&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))&&(this[name]=undefined)},stop:function(){this.done=!0;var rootRecord=this.tryEntries[0].completion;if("throw"===rootRecord.type)throw rootRecord.arg;return this.rval},dispatchException:function(exception){if(this.done)throw exception;var context=this;function handle(loc,caught){return record.type="throw",record.arg=exception,context.next=loc,caught&&(context.method="next",context.arg=undefined),!!caught}for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i],record=entry.completion;if("root"===entry.tryLoc)return handle("end");if(entry.tryLoc<=this.prev){var hasCatch=hasOwn.call(entry,"catchLoc"),hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0);if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc)}else if(hasCatch){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0)}else{if(!hasFinally)throw new Error("try statement without catch or finally");if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc)}}}},abrupt:function(type,arg){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break}}finallyEntry&&("break"===type||"continue"===type)&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc&&(finallyEntry=null);var record=finallyEntry?finallyEntry.completion:{};return record.type=type,record.arg=arg,finallyEntry?(this.method="next",this.next=finallyEntry.finallyLoc,ContinueSentinel):this.complete(record)},complete:function(record,afterLoc){if("throw"===record.type)throw record.arg;return"break"===record.type||"continue"===record.type?this.next=record.arg:"return"===record.type?(this.rval=this.arg=record.arg,this.method="return",this.next="end"):"normal"===record.type&&afterLoc&&(this.next=afterLoc),ContinueSentinel},finish:function(finallyLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc)return this.complete(entry.completion,entry.afterLoc),resetTryEntry(entry),ContinueSentinel}},catch:function(tryLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){var record=entry.completion;if("throw"===record.type){var thrown=record.arg;resetTryEntry(entry)}return thrown}}throw new Error("illegal catch attempt")},delegateYield:function(iterable,resultName,nextLoc){return this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc},"next"===this.method&&(this.arg=undefined),ContinueSentinel}},exports}function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});Object.defineProperty(subClass,"prototype",{writable:false});if(superClass)_setPrototypeOf(subClass,superClass)}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _possibleConstructorReturn(self,call){if(call&&(typeof call==="object"||typeof call==="function")){return call}else if(call!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return _assertThisInitialized(self)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _superPropBase(object,property){while(!Object.prototype.hasOwnProperty.call(object,property)){object=_getPrototypeOf(object);if(object===null)break}return object}function _get(){if(typeof Reflect!=="undefined"&&Reflect.get){_get=Reflect.get.bind()}else{_get=function _get(target,property,receiver){var base=_superPropBase(target,property);if(!base)return;var desc=Object.getOwnPropertyDescriptor(base,property);if(desc.get){return desc.get.call(arguments.length<3?target:receiver)}return desc.value}}return _get.apply(this,arguments)}function _classPrivateFieldGet(receiver,privateMap){var descriptor=_classExtractFieldDescriptor(receiver,privateMap,"get");return _classApplyDescriptorGet(receiver,descriptor)}function _classPrivateFieldSet(receiver,privateMap,value){var descriptor=_classExtractFieldDescriptor(receiver,privateMap,"set");_classApplyDescriptorSet(receiver,descriptor,value);return value}function _classExtractFieldDescriptor(receiver,privateMap,action){if(!privateMap.has(receiver)){throw new TypeError("attempted to "+action+" private field on non-instance")}return privateMap.get(receiver)}function _classApplyDescriptorGet(receiver,descriptor){if(descriptor.get){return descriptor.get.call(receiver)}return descriptor.value}function _classApplyDescriptorSet(receiver,descriptor,value){if(descriptor.set){descriptor.set.call(receiver,value)}else{if(!descriptor.writable){throw new TypeError("attempted to set read only private field")}descriptor.value=value}}function _checkPrivateRedeclaration(obj,privateCollection){if(privateCollection.has(obj)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateFieldInitSpec(obj,privateMap,value){_checkPrivateRedeclaration(obj,privateMap);privateMap.set(obj,value)}var OPL3$1=function(){function OPL3(){_classCallCheck(this,OPL3);this.nts=0;this.dam=0;this.dvb=0;this.ryt=0;this.bd=0;this.sd=0;this.tom=0;this.tc=0;this.hh=0;this._new=0;this.connectionsel=0;this.vibratoIndex=0;this.tremoloIndex=0;this.registers=new Int32Array(512);this.channels=[new Array(9),new Array(9)];this.initOperators();this.initChannels2op();this.initChannels4op();this.initRhythmChannels();this.initChannels();this.output=new Int16Array(2);this.outputBuffer=new Float64Array(4);this.outputChannelNumber=2}_createClass(OPL3,[{key:"read",value:function read(output,seek,len){var offset=seek||0;output=output||this.output;var output_length=len||output.length;var converterScale=output instanceof Float32Array?32768:1;do{var channelOutput,outputChannelNumber;for(outputChannelNumber=0;outputChannelNumber<4;outputChannelNumber++){this.outputBuffer[outputChannelNumber]=0}for(var array=0;array<this._new+1;array++){for(var channelNumber=0;channelNumber<9;channelNumber++){channelOutput=this.channels[array][channelNumber].getChannelOutput();for(outputChannelNumber=0;outputChannelNumber<4;outputChannelNumber++){this.outputBuffer[outputChannelNumber]+=channelOutput[outputChannelNumber]}}}for(outputChannelNumber=0;outputChannelNumber<this.outputChannelNumber;outputChannelNumber++){output[offset+outputChannelNumber]=this.outputBuffer[outputChannelNumber]/18*32767/converterScale}this.vibratoIndex++;if(this.vibratoIndex>=OPL3Data.vibratoTable[this.dvb].length)this.vibratoIndex=0;this.tremoloIndex++;if(this.tremoloIndex>=OPL3Data.tremoloTable[this.dam].length)this.tremoloIndex=0;offset+=this.outputChannelNumber}while(offset<output_length);return output}},{key:"write",value:function write(array,address,data){var registerAddress=array<<8|address;if(registerAddress<0||registerAddress>=512)return;this.registers[registerAddress]=data;switch(address&224){case 0:if(array==1){if(address==4)this.update_2_CONNECTIONSEL6();else if(address==5){this.update_7_NEW1()}}else if(address==8)this.update_1_NTS1_6();break;case 160:if(address==189){if(array==0)this.update_DAM1_DVB1_RYT1_BD1_SD1_TOM1_TC1_HH1();break}if((address&240)==176&&address<=184){this.channels[array][address&15].update_2_KON1_BLOCK3_FNUMH2();break}if((address&240)==160&&address<=168)this.channels[array][address&15].update_FNUML8();break;case 192:if(address<=200)this.channels[array][address&15].update_CHD1_CHC1_CHB1_CHA1_FB3_CNT1();break;default:var operatorOffset=address&31;if(!this.operators[array][operatorOffset])break;switch(address&224){case 32:this.operators[array][operatorOffset].update_AM1_VIB1_EGT1_KSR1_MULT4();break;case 64:this.operators[array][operatorOffset].update_KSL2_TL6();break;case 96:this.operators[array][operatorOffset].update_AR4_DR4();break;case 128:this.operators[array][operatorOffset].update_SL4_RR4();break;case 224:this.operators[array][operatorOffset].update_5_WS3()}}}},{key:"initOperators",value:function initOperators(){this.operators=[[],[]];for(var array=0;array<2;array++){for(var group=0;group<=16;group+=8){for(var offset=0;offset<6;offset++){var baseAddress=array<<8|group+offset;this.operators[array][group+offset]=new Operator(baseAddress,this)}}}this.highHatOperator=new HighHatOperator(this);this.snareDrumOperator=new SnareDrumOperator(this);this.tomTomOperator=new TomTomOperator(this);this.topCymbalOperator=new TopCymbalOperator(this);this.highHatOperatorInNonRhythmMode=this.operators[0][17];this.snareDrumOperatorInNonRhythmMode=this.operators[0][20];this.tomTomOperatorInNonRhythmMode=this.operators[0][18];this.topCymbalOperatorInNonRhythmMode=this.operators[0][21]}},{key:"initChannels2op",value:function initChannels2op(){this.channels2op=[[],[]];for(var array=0;array<2;array++){for(var channelNumber=0;channelNumber<3;channelNumber++){var baseAddress=array<<8|channelNumber;this.channels2op[array][channelNumber]=new Channel2op(baseAddress,this.operators[array][channelNumber],this.operators[array][channelNumber+3],this);this.channels2op[array][channelNumber+3]=new Channel2op(baseAddress+3,this.operators[array][channelNumber+8],this.operators[array][channelNumber+11],this);this.channels2op[array][channelNumber+6]=new Channel2op(baseAddress+6,this.operators[array][channelNumber+16],this.operators[array][channelNumber+19],this)}}}},{key:"initChannels4op",value:function initChannels4op(){this.channels4op=[[],[]];for(var array=0;array<2;array++){for(var channelNumber=0;channelNumber<3;channelNumber++){var baseAddress=array<<8|channelNumber;this.channels4op[array][channelNumber]=new Channel4op(baseAddress,this.operators[array][channelNumber],this.operators[array][channelNumber+3],this.operators[array][channelNumber+8],this.operators[array][channelNumber+11],this)}}}},{key:"initRhythmChannels",value:function initRhythmChannels(){this.bassDrumChannel=new BassDrumChannel(this);this.highHatSnareDrumChannel=new HighHatSnareDrumChannel(this);this.tomTomTopCymbalChannel=new TomTomTopCymbalChannel(this)}},{key:"initChannels",value:function initChannels(){for(var array=0;array<2;array++){for(var i=0;i<9;i++){this.channels[array][i]=this.channels2op[array][i]}}this.disabledChannel=new DisabledChannel(this)}},{key:"update_1_NTS1_6",value:function update_1_NTS1_6(){var _1_nts1_6=this.registers[OPL3Data._1_NTS1_6_Offset];this.nts=(_1_nts1_6&64)>>6}},{key:"update_DAM1_DVB1_RYT1_BD1_SD1_TOM1_TC1_HH1",value:function update_DAM1_DVB1_RYT1_BD1_SD1_TOM1_TC1_HH1(){var dam1_dvb1_ryt1_bd1_sd1_tom1_tc1_hh1=this.registers[OPL3Data.DAM1_DVB1_RYT1_BD1_SD1_TOM1_TC1_HH1_Offset];this.dam=(dam1_dvb1_ryt1_bd1_sd1_tom1_tc1_hh1&128)>>7;this.dvb=(dam1_dvb1_ryt1_bd1_sd1_tom1_tc1_hh1&64)>>6;var new_ryt=(dam1_dvb1_ryt1_bd1_sd1_tom1_tc1_hh1&32)>>5;if(new_ryt!=this.ryt){this.ryt=new_ryt;this.setRhythmMode()}var new_bd=(dam1_dvb1_ryt1_bd1_sd1_tom1_tc1_hh1&16)>>4;if(new_bd!=this.bd){this.bd=new_bd;if(this.bd==1){this.bassDrumChannel.op1.keyOn();this.bassDrumChannel.op2.keyOn()}}var new_sd=(dam1_dvb1_ryt1_bd1_sd1_tom1_tc1_hh1&8)>>3;if(new_sd!=this.sd){this.sd=new_sd;if(this.sd==1)this.snareDrumOperator.keyOn()}var new_tom=(dam1_dvb1_ryt1_bd1_sd1_tom1_tc1_hh1&4)>>2;if(new_tom!=this.tom){this.tom=new_tom;if(this.tom==1)this.tomTomOperator.keyOn()}var new_tc=(dam1_dvb1_ryt1_bd1_sd1_tom1_tc1_hh1&2)>>1;if(new_tc!=this.tc){this.tc=new_tc;if(this.tc==1)this.topCymbalOperator.keyOn()}var new_hh=dam1_dvb1_ryt1_bd1_sd1_tom1_tc1_hh1&1;if(new_hh!=this.hh){this.hh=new_hh;if(this.hh==1)this.highHatOperator.keyOn()}}},{key:"update_7_NEW1",value:function update_7_NEW1(){var _7_new1=this.registers[OPL3Data._7_NEW1_Offset];this._new=_7_new1&1;if(this._new==1)this.setEnabledChannels();this.set4opConnections()}},{key:"setEnabledChannels",value:function setEnabledChannels(){for(var array=0;array<2;array++){for(var i=0;i<9;i++){var baseAddress=this.channels[array][i].channelBaseAddress;this.registers[baseAddress+ChannelData.CHD1_CHC1_CHB1_CHA1_FB3_CNT1_Offset]|=240;this.channels[array][i].update_CHD1_CHC1_CHB1_CHA1_FB3_CNT1()}}}},{key:"update_2_CONNECTIONSEL6",value:function update_2_CONNECTIONSEL6(){var _2_connectionsel6=this.registers[OPL3Data._2_CONNECTIONSEL6_Offset];this.connectionsel=_2_connectionsel6&63;this.set4opConnections()}},{key:"set4opConnections",value:function set4opConnections(){for(var array=0;array<2;++array){for(var i=0;i<3;++i){if(this._new==1){var shift=array*3+i;var connectionBit=this.connectionsel>>shift&1;if(connectionBit==1){this.channels[array][i]=this.channels4op[array][i];this.channels[array][i+3]=this.disabledChannel;this.channels[array][i].updateChannel();continue}}this.channels[array][i]=this.channels2op[array][i];this.channels[array][i+3]=this.channels2op[array][i+3];this.channels[array][i].updateChannel();this.channels[array][i+3].updateChannel()}}}},{key:"setRhythmMode",value:function setRhythmMode(){var i;if(this.ryt==1){this.channels[0][6]=this.bassDrumChannel;this.channels[0][7]=this.highHatSnareDrumChannel;this.channels[0][8]=this.tomTomTopCymbalChannel;this.operators[0][17]=this.highHatOperator;this.operators[0][20]=this.snareDrumOperator;this.operators[0][18]=this.tomTomOperator;this.operators[0][21]=this.topCymbalOperator}else{for(i=6;i<=8;i++){this.channels[0][i]=this.channels2op[0][i]}this.operators[0][17]=this.highHatOperatorInNonRhythmMode;this.operators[0][20]=this.snareDrumOperatorInNonRhythmMode;this.operators[0][18]=this.tomTomOperatorInNonRhythmMode;this.operators[0][21]=this.topCymbalOperatorInNonRhythmMode}for(i=6;i<=8;i++){this.channels[0][i].updateChannel()}}}]);return OPL3}();var opl3$1=OPL3$1;var Channel=function(){function Channel(baseAddress,opl){_classCallCheck(this,Channel);this.opl=opl;this.channelBaseAddress=baseAddress;this.fnuml=0;this.fnumh=0;this.kon=0;this.block=0;this.cha=0;this.chb=0;this.chc=0;this.chd=0;this.fb=0;this.cnt=0;this.feedback=[0,0];this.toPhase=4;this.output=new Float64Array(4)}_createClass(Channel,[{key:"update_2_KON1_BLOCK3_FNUMH2",value:function update_2_KON1_BLOCK3_FNUMH2(){var _2_kon1_block3_fnumh2=this.opl.registers[this.channelBaseAddress+ChannelData._2_KON1_BLOCK3_FNUMH2_Offset];this.block=(_2_kon1_block3_fnumh2&28)>>2;this.fnumh=_2_kon1_block3_fnumh2&3;this.updateOperators();var newKon=(_2_kon1_block3_fnumh2&32)>>5;if(newKon!=this.kon){if(newKon==1)this.keyOn();else this.keyOff();this.kon=newKon}}},{key:"update_FNUML8",value:function update_FNUML8(){var fnuml8=this.opl.registers[this.channelBaseAddress+ChannelData.FNUML8_Offset];this.fnuml=fnuml8&255;this.updateOperators()}},{key:"update_CHD1_CHC1_CHB1_CHA1_FB3_CNT1",value:function update_CHD1_CHC1_CHB1_CHA1_FB3_CNT1(){var chd1_chc1_chb1_cha1_fb3_cnt1=this.opl.registers[this.channelBaseAddress+ChannelData.CHD1_CHC1_CHB1_CHA1_FB3_CNT1_Offset];this.chd=(chd1_chc1_chb1_cha1_fb3_cnt1&128)>>7;this.chc=(chd1_chc1_chb1_cha1_fb3_cnt1&64)>>6;this.chb=(chd1_chc1_chb1_cha1_fb3_cnt1&32)>>5;this.cha=(chd1_chc1_chb1_cha1_fb3_cnt1&16)>>4;this.fb=(chd1_chc1_chb1_cha1_fb3_cnt1&14)>>1;this.cnt=chd1_chc1_chb1_cha1_fb3_cnt1&1;this.updateOperators()}},{key:"updateChannel",value:function updateChannel(){this.update_2_KON1_BLOCK3_FNUMH2();this.update_FNUML8();this.update_CHD1_CHC1_CHB1_CHA1_FB3_CNT1()}},{key:"getInFourChannels",value:function getInFourChannels(channelOutput){if(this.opl._new==0){this.output[0]=this.output[1]=this.output[2]=this.output[3]=channelOutput}else{this.output[0]=this.cha==1?channelOutput:0;this.output[1]=this.chb==1?channelOutput:0;this.output[2]=this.chc==1?channelOutput:0;this.output[3]=this.chd==1?channelOutput:0}return this.output}}]);return Channel}();var Channel2op=function(_Channel){_inherits(Channel2op,_Channel);var _super=_createSuper(Channel2op);function Channel2op(baseAddress,o1,o2,opl){var _this;_classCallCheck(this,Channel2op);_this=_super.call(this,baseAddress,opl);_this.op1=o1;_this.op2=o2;return _this}_createClass(Channel2op,[{key:"getChannelOutput",value:function getChannelOutput(){var channelOutput=0,op1Output=0,op2Output=0;var feedbackOutput=(this.feedback[0]+this.feedback[1])/2;if(this.cnt==0){if(this.op2.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF)return this.getInFourChannels(0);op1Output=this.op1.getOperatorOutput(feedbackOutput);channelOutput=this.op2.getOperatorOutput(op1Output*this.toPhase)}else{if(this.op1.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF&&this.op2.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF)return this.getInFourChannels(0);op1Output=this.op1.getOperatorOutput(feedbackOutput);op2Output=this.op2.getOperatorOutput(Operator.noModulator);channelOutput=(op1Output+op2Output)/2}this.feedback[0]=this.feedback[1];this.feedback[1]=op1Output*ChannelData.feedback[this.fb]%1;return this.getInFourChannels(channelOutput)}},{key:"keyOn",value:function keyOn(){this.op1.keyOn();this.op2.keyOn();this.feedback[0]=this.feedback[1]=0}},{key:"keyOff",value:function keyOff(){this.op1.keyOff();this.op2.keyOff()}},{key:"updateOperators",value:function updateOperators(){var keyScaleNumber=this.block*2+(this.fnumh>>this.opl.nts&1);var f_number=this.fnumh<<8|this.fnuml;this.op1.updateOperator(keyScaleNumber,f_number,this.block);this.op2.updateOperator(keyScaleNumber,f_number,this.block)}}]);return Channel2op}(Channel);var Channel4op=function(_Channel2){_inherits(Channel4op,_Channel2);var _super2=_createSuper(Channel4op);function Channel4op(baseAddress,o1,o2,o3,o4,opl){var _this2;_classCallCheck(this,Channel4op);_this2=_super2.call(this,baseAddress,opl);_this2.op1=o1;_this2.op2=o2;_this2.op3=o3;_this2.op4=o4;return _this2}_createClass(Channel4op,[{key:"getChannelOutput",value:function getChannelOutput(){var channelOutput=0,op1Output=0,op2Output=0,op3Output=0,op4Output=0;var secondChannelBaseAddress=this.channelBaseAddress+3;var secondCnt=this.opl.registers[secondChannelBaseAddress+ChannelData.CHD1_CHC1_CHB1_CHA1_FB3_CNT1_Offset]&1;var cnt4op=this.cnt<<1|secondCnt;var feedbackOutput=(this.feedback[0]+this.feedback[1])/2;switch(cnt4op){case 0:if(this.op4.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF)return this.getInFourChannels(0);op1Output=this.op1.getOperatorOutput(feedbackOutput);op2Output=this.op2.getOperatorOutput(op1Output*this.toPhase);op3Output=this.op3.getOperatorOutput(op2Output*this.toPhase);channelOutput=this.op4.getOperatorOutput(op3Output*this.toPhase);break;case 1:if(this.op2.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF&&this.op4.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF)return this.getInFourChannels(0);op1Output=this.op1.getOperatorOutput(feedbackOutput);op2Output=this.op2.getOperatorOutput(op1Output*this.toPhase);op3Output=this.op3.getOperatorOutput(Operator.noModulator);op4Output=this.op4.getOperatorOutput(op3Output*this.toPhase);channelOutput=(op2Output+op4Output)/2;break;case 2:if(this.op1.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF&&this.op4.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF)return this.getInFourChannels(0);op1Output=this.op1.getOperatorOutput(feedbackOutput);op2Output=this.op2.getOperatorOutput(Operator.noModulator);op3Output=this.op3.getOperatorOutput(op2Output*this.toPhase);op4Output=this.op4.getOperatorOutput(op3Output*this.toPhase);channelOutput=(op1Output+op4Output)/2;break;case 3:if(this.op1.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF&&this.op3.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF&&this.op4.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF)return this.getInFourChannels(0);op1Output=this.op1.getOperatorOutput(feedbackOutput);op2Output=this.op2.getOperatorOutput(Operator.noModulator);op3Output=this.op3.getOperatorOutput(op2Output*this.toPhase);op4Output=this.op4.getOperatorOutput(Operator.noModulator);channelOutput=(op1Output+op3Output+op4Output)/3;break}this.feedback[0]=this.feedback[1];this.feedback[1]=op1Output*ChannelData.feedback[this.fb]%1;return this.getInFourChannels(channelOutput)}},{key:"keyOn",value:function keyOn(){this.op1.keyOn();this.op2.keyOn();this.op3.keyOn();this.op4.keyOn();this.feedback[0]=this.feedback[1]=0}},{key:"keyOff",value:function keyOff(){this.op1.keyOff();this.op2.keyOff();this.op3.keyOff();this.op4.keyOff()}},{key:"updateOperators",value:function updateOperators(){var keyScaleNumber=this.block*2+(this.fnumh>>this.opl.nts&1);var f_number=this.fnumh<<8|this.fnuml;this.op1.updateOperator(keyScaleNumber,f_number,this.block);this.op2.updateOperator(keyScaleNumber,f_number,this.block);this.op3.updateOperator(keyScaleNumber,f_number,this.block);this.op4.updateOperator(keyScaleNumber,f_number,this.block)}}]);return Channel4op}(Channel);var DisabledChannel=function(_Channel3){_inherits(DisabledChannel,_Channel3);var _super3=_createSuper(DisabledChannel);function DisabledChannel(opl){var _this3;_classCallCheck(this,DisabledChannel);_this3=_super3.call(this,0,opl);_this3.opl=opl;return _this3}_createClass(DisabledChannel,[{key:"getChannelOutput",value:function getChannelOutput(){return this.getInFourChannels(0)}},{key:"keyOn",value:function keyOn(){}},{key:"keyOff",value:function keyOff(){}},{key:"updateOperators",value:function updateOperators(){}}]);return DisabledChannel}(Channel);var Operator=function(){function Operator(baseAddress,opl){_classCallCheck(this,Operator);this.opl=opl;this.operatorBaseAddress=baseAddress;this.phaseGenerator=new PhaseGenerator(opl);this.envelopeGenerator=new EnvelopeGenerator(opl);this.envelope=0;this.am=0;this.vib=0;this.ksr=0;this.egt=0;this.mult=0;this.ksl=0;this.tl=0;this.ar=0;this.dr=0;this.sl=0;this.rr=0;this.ws=0;this.keyScaleNumber=0;this.f_number=0;this.block=0}_createClass(Operator,[{key:"update_AM1_VIB1_EGT1_KSR1_MULT4",value:function update_AM1_VIB1_EGT1_KSR1_MULT4(){var am1_vib1_egt1_ksr1_mult4=this.opl.registers[this.operatorBaseAddress+OperatorData.AM1_VIB1_EGT1_KSR1_MULT4_Offset];this.am=(am1_vib1_egt1_ksr1_mult4&128)>>7;this.vib=(am1_vib1_egt1_ksr1_mult4&64)>>6;this.egt=(am1_vib1_egt1_ksr1_mult4&32)>>5;this.ksr=(am1_vib1_egt1_ksr1_mult4&16)>>4;this.mult=am1_vib1_egt1_ksr1_mult4&15;this.phaseGenerator.setFrequency(this.f_number,this.block,this.mult);this.envelopeGenerator.setActualAttackRate(this.ar,this.ksr,this.keyScaleNumber);this.envelopeGenerator.setActualDecayRate(this.dr,this.ksr,this.keyScaleNumber);this.envelopeGenerator.setActualReleaseRate(this.rr,this.ksr,this.keyScaleNumber)}},{key:"update_KSL2_TL6",value:function update_KSL2_TL6(){var ksl2_tl6=this.opl.registers[this.operatorBaseAddress+OperatorData.KSL2_TL6_Offset];this.ksl=(ksl2_tl6&192)>>6;this.tl=ksl2_tl6&63;this.envelopeGenerator.setAtennuation(this.f_number,this.block,this.ksl);this.envelopeGenerator.setTotalLevel(this.tl)}},{key:"update_AR4_DR4",value:function update_AR4_DR4(){var ar4_dr4=this.opl.registers[this.operatorBaseAddress+OperatorData.AR4_DR4_Offset];this.ar=(ar4_dr4&240)>>4;this.dr=ar4_dr4&15;this.envelopeGenerator.setActualAttackRate(this.ar,this.ksr,this.keyScaleNumber);this.envelopeGenerator.setActualDecayRate(this.dr,this.ksr,this.keyScaleNumber)}},{key:"update_SL4_RR4",value:function update_SL4_RR4(){var sl4_rr4=this.opl.registers[this.operatorBaseAddress+OperatorData.SL4_RR4_Offset];this.sl=(sl4_rr4&240)>>4;this.rr=sl4_rr4&15;this.envelopeGenerator.setActualSustainLevel(this.sl);this.envelopeGenerator.setActualReleaseRate(this.rr,this.ksr,this.keyScaleNumber)}},{key:"update_5_WS3",value:function update_5_WS3(){var _5_ws3=this.opl.registers[this.operatorBaseAddress+OperatorData._5_WS3_Offset];this.ws=_5_ws3&7}},{key:"getOperatorOutput",value:function getOperatorOutput(modulator){if(this.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF)return 0;var envelopeInDB=this.envelopeGenerator.getEnvelope(this.egt,this.am);this.envelope=Math.pow(10,envelopeInDB/10);this.ws=this.ws&(this.opl._new<<2)+3;var waveform=OperatorData.waveforms[this.ws];this.phase=this.phaseGenerator.getPhase(this.vib);return this.getOutput(modulator,this.phase,waveform)}},{key:"getOutput",value:function getOutput(modulator,outputPhase,waveform){outputPhase=(outputPhase+modulator)%1;if(outputPhase<0){outputPhase++;outputPhase%=1}var sampleIndex=outputPhase*OperatorData.waveLength|0;return waveform[sampleIndex]*this.envelope}},{key:"keyOn",value:function keyOn(){if(this.ar>0){this.envelopeGenerator.keyOn();this.phaseGenerator.keyOn()}else this.envelopeGenerator.stage=EnvelopeGenerator.Stage.OFF}},{key:"keyOff",value:function keyOff(){this.envelopeGenerator.keyOff()}},{key:"updateOperator",value:function updateOperator(ksn,f_num,blk){this.keyScaleNumber=ksn;this.f_number=f_num;this.block=blk;this.update_AM1_VIB1_EGT1_KSR1_MULT4();this.update_KSL2_TL6();this.update_AR4_DR4();this.update_SL4_RR4();this.update_5_WS3()}}]);return Operator}();_defineProperty(Operator,"noModulator",0);var EnvelopeGenerator=function(){function EnvelopeGenerator(opl){_classCallCheck(this,EnvelopeGenerator);this.opl=opl;this.stage=EnvelopeGenerator.Stage.OFF;this.actualAttackRate=0;this.actualDecayRate=0;this.actualReleaseRate=0;this.xAttackIncrement=0;this.xMinimumInAttack=0;this.dBdecayIncrement=0;this.dBreleaseIncrement=0;this.attenuation=0;this.totalLevel=0;this.sustainLevel=0;this.x=this.dBtoX(-96);this.resolutionMaximum=this.dBtoX(-.1875);this.percentage10=this.percentageToX(.1);this.percentage90=this.percentageToX(.9);this.envelope=-96}_createClass(EnvelopeGenerator,[{key:"setActualSustainLevel",value:function setActualSustainLevel(sl){if(sl==15){this.sustainLevel=-93;return}this.sustainLevel=-3*sl}},{key:"setTotalLevel",value:function setTotalLevel(tl){this.totalLevel=tl*-.75}},{key:"setAtennuation",value:function setAtennuation(f_number,block,ksl){var hi4bits=f_number>>6&15;switch(ksl){case 0:this.attenuation=0;break;case 1:this.attenuation=OperatorData.ksl3dBtable[hi4bits][block];break;case 2:this.attenuation=OperatorData.ksl3dBtable[hi4bits][block]/2;break;case 3:this.attenuation=OperatorData.ksl3dBtable[hi4bits][block]*2}}},{key:"setActualAttackRate",value:function setActualAttackRate(attackRate,ksr,keyScaleNumber){this.actualAttackRate=this.calculateActualRate(attackRate,ksr,keyScaleNumber)|0;var period0to100inSeconds=EnvelopeGeneratorData.attackTimeValuesTable[this.actualAttackRate][0]/1e3;var period0to100inSamples=period0to100inSeconds*OPL3Data.sampleRate|0;var period10to90inSeconds=EnvelopeGeneratorData.attackTimeValuesTable[this.actualAttackRate][1]/1e3;var period10to90inSamples=period10to90inSeconds*OPL3Data.sampleRate|0;this.xAttackIncrement=OPL3Data.calculateIncrement(this.percentage10,this.percentage90,period10to90inSeconds);var period10to100inSamples=period10to90inSamples+(this.resolutionMaximum-this.percentage90)/this.xAttackIncrement|0;this.xMinimumInAttack=this.percentage10-(period0to100inSamples-period10to100inSamples)*this.xAttackIncrement}},{key:"setActualDecayRate",value:function setActualDecayRate(decayRate,ksr,keyScaleNumber){this.actualDecayRate=this.calculateActualRate(decayRate,ksr,keyScaleNumber)|0;var period10to90inSeconds=EnvelopeGeneratorData.decayAndReleaseTimeValuesTable[this.actualDecayRate][1]/1e3;this.dBdecayIncrement=OPL3Data.calculateIncrement(this.percentageToDB(.1),this.percentageToDB(.9),period10to90inSeconds)}},{key:"setActualReleaseRate",value:function setActualReleaseRate(releaseRate,ksr,keyScaleNumber){this.actualReleaseRate=this.calculateActualRate(releaseRate,ksr,keyScaleNumber)|0;var period10to90inSeconds=EnvelopeGeneratorData.decayAndReleaseTimeValuesTable[this.actualReleaseRate][1]/1e3;this.dBreleaseIncrement=OPL3Data.calculateIncrement(this.percentageToDB(.1),this.percentageToDB(.9),period10to90inSeconds)}},{key:"calculateActualRate",value:function calculateActualRate(rate,ksr,keyScaleNumber){var rof=EnvelopeGeneratorData.rateOffset[ksr][keyScaleNumber];var actualRate=rate*4+rof;if(actualRate>63)actualRate=63;return actualRate}},{key:"getEnvelope",value:function getEnvelope(egt,am){var envelopeSustainLevel=this.sustainLevel/2;var envelopeTremolo=OPL3Data.tremoloTable[this.opl.dam][this.opl.tremoloIndex]/2;var envelopeAttenuation=this.attenuation/2;var envelopeTotalLevel=this.totalLevel/2;var envelopeMinimum=-96;var envelopeResolution=.1875;var outputEnvelope;switch(this.stage){case EnvelopeGenerator.Stage.ATTACK:if(this.envelope<-envelopeResolution&&this.xAttackIncrement!=-Infinity){this.envelope=-Math.pow(2,this.x);this.x+=this.xAttackIncrement;break}else{this.envelope=0;this.stage=EnvelopeGenerator.Stage.DECAY}case EnvelopeGenerator.Stage.DECAY:if(this.envelope>envelopeSustainLevel){this.envelope-=this.dBdecayIncrement;break}else this.stage=EnvelopeGenerator.Stage.SUSTAIN;case EnvelopeGenerator.Stage.SUSTAIN:if(egt==1)break;else{if(this.envelope>envelopeMinimum)this.envelope-=this.dBreleaseIncrement;else this.stage=EnvelopeGenerator.Stage.OFF}break;case EnvelopeGenerator.Stage.RELEASE:if(this.envelope>envelopeMinimum)this.envelope-=this.dBreleaseIncrement;else this.stage=EnvelopeGenerator.Stage.OFF}outputEnvelope=this.envelope;if(am==1)outputEnvelope+=envelopeTremolo;outputEnvelope+=envelopeAttenuation;outputEnvelope+=envelopeTotalLevel;return outputEnvelope}},{key:"keyOn",value:function keyOn(){var xCurrent=Math.log2(-this.envelope);this.x=xCurrent<this.xMinimumInAttack?xCurrent:this.xMinimumInAttack;this.stage=EnvelopeGenerator.Stage.ATTACK}},{key:"keyOff",value:function keyOff(){if(this.stage!=EnvelopeGenerator.Stage.OFF)this.stage=EnvelopeGenerator.Stage.RELEASE}},{key:"dBtoX",value:function dBtoX(dB){return Math.log2(-dB)}},{key:"percentageToDB",value:function percentageToDB(percentage){return Math.log10(percentage)*10}},{key:"percentageToX",value:function percentageToX(percentage){return this.dBtoX(this.percentageToDB(percentage))}}]);return EnvelopeGenerator}();_defineProperty(EnvelopeGenerator,"Stage",{ATTACK:"ATTACK",DECAY:"DECAY",SUSTAIN:"SUSTAIN",RELEASE:"RELEASE",OFF:"OFF"});var PhaseGenerator=function(){function PhaseGenerator(opl){_classCallCheck(this,PhaseGenerator);this.opl=opl;this.phase=0;this.phaseIncrement=0}_createClass(PhaseGenerator,[{key:"setFrequency",value:function setFrequency(f_number,block,mult){var baseFrequency=f_number*Math.pow(2,block-1)*OPL3Data.sampleRate/Math.pow(2,19);var operatorFrequency=baseFrequency*OperatorData.multTable[mult];this.phaseIncrement=operatorFrequency/OPL3Data.sampleRate}},{key:"getPhase",value:function getPhase(vib){if(vib==1){this.phase+=this.phaseIncrement*OPL3Data.vibratoTable[this.opl.dvb][this.opl.vibratoIndex]}else{this.phase+=this.phaseIncrement}this.phase%=1;return this.phase}},{key:"keyOn",value:function keyOn(){this.phase=0}}]);return PhaseGenerator}();var RhythmChannel=function(_Channel2op){_inherits(RhythmChannel,_Channel2op);var _super4=_createSuper(RhythmChannel);function RhythmChannel(baseAddress,o1,o2,opl){_classCallCheck(this,RhythmChannel);return _super4.call(this,baseAddress,o1,o2,opl)}_createClass(RhythmChannel,[{key:"getChannelOutput",value:function getChannelOutput(){var channelOutput=0,op1Output=0,op2Output=0;op1Output=this.op1.getOperatorOutput(Operator.noModulator);op2Output=this.op2.getOperatorOutput(Operator.noModulator);channelOutput=(op1Output+op2Output)/2;return this.getInFourChannels(channelOutput)}},{key:"keyOn",value:function keyOn(){}},{key:"keyOff",value:function keyOff(){}}]);return RhythmChannel}(Channel2op);var HighHatSnareDrumChannel=function(_RhythmChannel){_inherits(HighHatSnareDrumChannel,_RhythmChannel);var _super5=_createSuper(HighHatSnareDrumChannel);function HighHatSnareDrumChannel(opl){_classCallCheck(this,HighHatSnareDrumChannel);return _super5.call(this,7,opl.highHatOperator,opl.snareDrumOperator,opl)}return _createClass(HighHatSnareDrumChannel)}(RhythmChannel);var TomTomTopCymbalChannel=function(_RhythmChannel2){_inherits(TomTomTopCymbalChannel,_RhythmChannel2);var _super6=_createSuper(TomTomTopCymbalChannel);function TomTomTopCymbalChannel(opl){_classCallCheck(this,TomTomTopCymbalChannel);return _super6.call(this,8,opl.tomTomOperator,opl.topCymbalOperator,opl)}return _createClass(TomTomTopCymbalChannel)}(RhythmChannel);var TopCymbalOperator=function(_Operator){_inherits(TopCymbalOperator,_Operator);var _super7=_createSuper(TopCymbalOperator);function TopCymbalOperator(baseAddress,opl){_classCallCheck(this,TopCymbalOperator);if(arguments.length==1){opl=baseAddress;baseAddress=21}return _super7.call(this,baseAddress,opl)}_createClass(TopCymbalOperator,[{key:"getOperatorOutput",value:function getOperatorOutput(modulator,externalPhase){if(typeof externalPhase=="undefined")externalPhase=this.opl.highHatOperator.phase*OperatorData.multTable[this.opl.highHatOperator.mult];var envelopeInDB=this.envelopeGenerator.getEnvelope(this.egt,this.am);this.envelope=Math.pow(10,envelopeInDB/10);this.phase=this.phaseGenerator.getPhase(this.vib);var waveIndex=this.ws&(this.opl._new<<2)+3|0;var waveform=OperatorData.waveforms[waveIndex];var carrierPhase=8*this.phase%1;var modulatorPhase=externalPhase;var modulatorOutput=this.getOutput(Operator.noModulator,modulatorPhase,waveform);var carrierOutput=this.getOutput(modulatorOutput,carrierPhase,waveform);var cycles=4;if(carrierPhase*cycles%cycles>.1)carrierOutput=0;return carrierOutput*2}}]);return TopCymbalOperator}(Operator);var HighHatOperator=function(_TopCymbalOperator){_inherits(HighHatOperator,_TopCymbalOperator);var _super8=_createSuper(HighHatOperator);function HighHatOperator(opl){_classCallCheck(this,HighHatOperator);return _super8.call(this,17,opl)}_createClass(HighHatOperator,[{key:"getOperatorOutput",value:function getOperatorOutput(modulator){var topCymbalOperatorPhase=this.opl.topCymbalOperator.phase*OperatorData.multTable[this.opl.topCymbalOperator.mult];var operatorOutput=_get(_getPrototypeOf(HighHatOperator.prototype),"getOperatorOutput",this).call(this,modulator,topCymbalOperatorPhase);if(operatorOutput==0)operatorOutput=Math.random()*this.envelope;return operatorOutput}}]);return HighHatOperator}(TopCymbalOperator);var SnareDrumOperator=function(_Operator2){_inherits(SnareDrumOperator,_Operator2);var _super9=_createSuper(SnareDrumOperator);function SnareDrumOperator(opl){_classCallCheck(this,SnareDrumOperator);return _super9.call(this,20,opl)}_createClass(SnareDrumOperator,[{key:"getOperatorOutput",value:function getOperatorOutput(modulator){if(this.envelopeGenerator.stage==EnvelopeGenerator.Stage.OFF)return 0;var envelopeInDB=this.envelopeGenerator.getEnvelope(this.egt,this.am);this.envelope=Math.pow(10,envelopeInDB/10);var waveIndex=this.ws&(this.opl._new<<2)+3|0;var waveform=OperatorData.waveforms[waveIndex];this.phase=this.opl.highHatOperator.phase*2;var operatorOutput=this.getOutput(modulator,this.phase,waveform);var noise=Math.random()*this.envelope;if(operatorOutput/this.envelope!=1&&operatorOutput/this.envelope!=-1){if(operatorOutput>0)operatorOutput=noise;else if(operatorOutput<0)operatorOutput=-noise;else operatorOutput=0}return operatorOutput*2}}]);return SnareDrumOperator}(Operator);var TomTomOperator=function(_Operator3){_inherits(TomTomOperator,_Operator3);var _super10=_createSuper(TomTomOperator);function TomTomOperator(opl){_classCallCheck(this,TomTomOperator);return _super10.call(this,18,opl)}return _createClass(TomTomOperator)}(Operator);var BassDrumChannel=function(_Channel2op2){_inherits(BassDrumChannel,_Channel2op2);var _super11=_createSuper(BassDrumChannel);function BassDrumChannel(opl){_classCallCheck(this,BassDrumChannel);return _super11.call(this,6,new Operator(16,opl),new Operator(19,opl),opl)}_createClass(BassDrumChannel,[{key:"getChannelOutput",value:function getChannelOutput(){if(this.cnt==1)this.op1.ar=0;return _get(_getPrototypeOf(BassDrumChannel.prototype),"getChannelOutput",this).call(this)}},{key:"keyOn",value:function keyOn(){}},{key:"keyOff",value:function keyOff(){}}]);return BassDrumChannel}(Channel2op);var OPL3Data={_1_NTS1_6_Offset:8,DAM1_DVB1_RYT1_BD1_SD1_TOM1_TC1_HH1_Offset:189,_7_NEW1_Offset:261,_2_CONNECTIONSEL6_Offset:260,sampleRate:49700,vibratoTable:[new Float64Array(8192),new Float64Array(8192)],tremoloTable:[new Float64Array(13432),new Float64Array(13432)],loadVibratoTable:function loadVibratoTable(vibratoTable){var semitone=Math.pow(2,1/12);var cent=Math.pow(semitone,1/100);var DVB0=Math.pow(cent,7);var DVB1=Math.pow(cent,14);var i;for(i=0;i<1024;i++){vibratoTable[0][i]=vibratoTable[1][i]=1}for(;i<2048;i++){vibratoTable[0][i]=Math.sqrt(DVB0);vibratoTable[1][i]=Math.sqrt(DVB1)}for(;i<3072;i++){vibratoTable[0][i]=DVB0;vibratoTable[1][i]=DVB1}for(;i<4096;i++){vibratoTable[0][i]=Math.sqrt(DVB0);vibratoTable[1][i]=Math.sqrt(DVB1)}for(;i<5120;i++){vibratoTable[0][i]=vibratoTable[1][i]=1}for(;i<6144;i++){vibratoTable[0][i]=1/Math.sqrt(DVB0);vibratoTable[1][i]=1/Math.sqrt(DVB1)}for(;i<7168;i++){vibratoTable[0][i]=1/DVB0;vibratoTable[1][i]=1/DVB1}for(;i<8192;i++){vibratoTable[0][i]=1/Math.sqrt(DVB0);vibratoTable[1][i]=1/Math.sqrt(DVB1)}},loadTremoloTable:function loadTremoloTable(tremoloTable){var tremoloFrequency=3.7;var tremoloDepth=[-1,-4.8];var tremoloIncrement=[OPL3Data.calculateIncrement(tremoloDepth[0],0,1/(2*tremoloFrequency)),OPL3Data.calculateIncrement(tremoloDepth[1],0,1/(2*tremoloFrequency))];var tremoloTableLength=OPL3Data.sampleRate/tremoloFrequency|0;tremoloTable[0][0]=tremoloDepth[0];tremoloTable[1][0]=tremoloDepth[1];var counter=0;while(tremoloTable[0][counter]<0){counter++;tremoloTable[0][counter]=tremoloTable[0][counter-1]+tremoloIncrement[0];tremoloTable[1][counter]=tremoloTable[1][counter-1]+tremoloIncrement[1]}while(tremoloTable[0][counter]>tremoloDepth[0]&&counter<tremoloTableLength-1){counter++;tremoloTable[0][counter]=tremoloTable[0][counter-1]-tremoloIncrement[0];tremoloTable[1][counter]=tremoloTable[1][counter-1]-tremoloIncrement[1]}},calculateIncrement:function calculateIncrement(begin,end,period){return(end-begin)/OPL3Data.sampleRate*(1/period)}};OPL3Data.loadVibratoTable(OPL3Data.vibratoTable);OPL3Data.loadTremoloTable(OPL3Data.tremoloTable);var ChannelData={_2_KON1_BLOCK3_FNUMH2_Offset:176,FNUML8_Offset:160,CHD1_CHC1_CHB1_CHA1_FB3_CNT1_Offset:192,feedback:[0,1/32,1/16,1/8,1/4,1/2,1,2]};var OperatorData={AM1_VIB1_EGT1_KSR1_MULT4_Offset:32,KSL2_TL6_Offset:64,AR4_DR4_Offset:96,SL4_RR4_Offset:128,_5_WS3_Offset:224,NO_MODULATION:"NO_MODULATION",CARRIER:"CARRIER",FEEDBACK:"FEEDBACK",waveLength:1024,multTable:[.5,1,2,3,4,5,6,7,8,9,10,10,12,12,15,15],ksl3dBtable:[[0,0,0,0,0,0,0,0],[0,0,0,0,0,-3,-6,-9],[0,0,0,0,-3,-6,-9,-12],[0,0,0,-1.875,-4.875,-7.875,-10.875,-13.875],[0,0,0,-3,-6,-9,-12,-15],[0,0,-1.125,-4.125,-7.125,-10.125,-13.125,-16.125],[0,0,-1.875,-4.875,-7.875,-10.875,-13.875,-16.875],[0,0,-2.625,-5.625,-8.625,-11.625,-14.625,-17.625],[0,0,-3,-6,-9,-12,-15,-18],[0,-.75,-3.75,-6.75,-9.75,-12.75,-15.75,-18.75],[0,-1.125,-4.125,-7.125,-10.125,-13.125,-16.125,-19.125],[0,-1.5,-4.5,-7.5,-10.5,-13.5,-16.5,-19.5],[0,-1.875,-4.875,-7.875,-10.875,-13.875,-16.875,-19.875],[0,-2.25,-5.25,-8.25,-11.25,-14.25,-17.25,-20.25],[0,-2.625,-5.625,-8.625,-11.625,-14.625,-17.625,-20.625],[0,-3,-6,-9,-12,-15,-18,-21]],waveforms:[new Float64Array(1024),new Float64Array(1024),new Float64Array(1024),new Float64Array(1024),new Float64Array(1024),new Float64Array(1024),new Float64Array(1024),new Float64Array(1024)],loadWaveforms:function loadWaveforms(waveforms){var i,theta,x;for(i=0,theta=0;i<1024;i++,theta+=2*Math.PI/1024){waveforms[0][i]=Math.sin(theta)}var sineTable=waveforms[0];for(i=0;i<512;i++){waveforms[1][i]=sineTable[i];waveforms[1][512+i]=0}for(i=0;i<512;i++){waveforms[2][i]=waveforms[2][512+i]=sineTable[i]}for(i=0;i<256;i++){waveforms[3][i]=waveforms[3][512+i]=sineTable[i];waveforms[3][256+i]=waveforms[3][768+i]=0}for(i=0;i<512;i++){waveforms[4][i]=sineTable[i*2];waveforms[4][512+i]=0}for(i=0;i<256;i++){waveforms[5][i]=waveforms[5][256+i]=sineTable[i*2];waveforms[5][512+i]=waveforms[5][768+i]=0}for(i=0;i<512;i++){waveforms[6][i]=1;waveforms[6][512+i]=-1}for(i=0,x=0;i<512;i++,x+=16/256){waveforms[7][i]=Math.pow(2,-x);waveforms[7][1023-i]=-Math.pow(2,-(x+1/16))}}};OperatorData.loadWaveforms(OperatorData.waveforms);var EnvelopeGeneratorData={rateOffset:[[0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3],[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]],attackTimeValuesTable:[[Infinity,Infinity],[Infinity,Infinity],[Infinity,Infinity],[Infinity,Infinity],[2826.24,1482.75],[2252.8,1155.07],[1884.16,991.23],[1597.44,868.35],[1413.12,741.38],[1126.4,577.54],[942.08,495.62],[798.72,434.18],[706.56,370.69],[563.2,288.77],[471.04,247.81],[399.36,217.09],[353.28,185.34],[281.6,144.38],[235.52,123.9],[199.68,108.54],[176.76,92.67],[140.8,72.19],[117.76,61.95],[99.84,54.27],[88.32,46.34],[70.4,36.1],[58.88,30.98],[49.92,27.14],[44.16,23.17],[35.2,18.05],[29.44,15.49],[24.96,13.57],[22.08,11.58],[17.6,9.02],[14.72,7.74],[12.48,6.78],[11.04,5.79],[8.8,4.51],[7.36,3.87],[6.24,3.39],[5.52,2.9],[4.4,2.26],[3.68,1.94],[3.12,1.7],[2.76,1.45],[2.2,1.13],[1.84,.97],[1.56,.85],[1.4,.73],[1.12,.61],[.92,.49],[.8,.43],[.7,.37],[.56,.31],[.46,.26],[.42,.22],[.38,.19],[.3,.14],[.24,.11],[.2,.11],[0,0],[0,0],[0,0],[0,0]],decayAndReleaseTimeValuesTable:[[Infinity,Infinity],[Infinity,Infinity],[Infinity,Infinity],[Infinity,Infinity],[39280.64,8212.48],[31416.32,6574.08],[26173.44,5509.12],[22446.08,4730.88],[19640.32,4106.24],[15708.16,3287.04],[13086.72,2754.56],[11223.04,2365.44],[9820.16,2053.12],[7854.08,1643.52],[6543.36,1377.28],[5611.52,1182.72],[4910.08,1026.56],[3927.04,821.76],[3271.68,688.64],[2805.76,591.36],[2455.04,513.28],[1936.52,410.88],[1635.84,344.34],[1402.88,295.68],[1227.52,256.64],[981.76,205.44],[817.92,172.16],[701.44,147.84],[613.76,128.32],[490.88,102.72],[488.96,86.08],[350.72,73.92],[306.88,64.16],[245.44,51.36],[204.48,43.04],[175.36,36.96],[153.44,32.08],[122.72,25.68],[102.24,21.52],[87.68,18.48],[76.72,16.04],[61.36,12.84],[51.12,10.76],[43.84,9.24],[38.36,8.02],[30.68,6.42],[25.56,5.38],[21.92,4.62],[19.2,4.02],[15.36,3.22],[12.8,2.68],[10.96,2.32],[9.6,2.02],[7.68,1.62],[6.4,1.35],[5.48,1.15],[4.8,1.01],[3.84,.81],[3.2,.69],[2.74,.58],[2.4,.51],[2.4,.51],[2.4,.51],[2.4,.51]]};var hasOwn=Object.prototype.hasOwnProperty;var toStr=Object.prototype.toString;var defineProperty=Object.defineProperty;var gOPD=Object.getOwnPropertyDescriptor;var isArray$2=function isArray(arr){if(typeof Array.isArray==="function"){return Array.isArray(arr)}return toStr.call(arr)==="[object Array]"};var isPlainObject=function isPlainObject(obj){if(!obj||toStr.call(obj)!=="[object Object]"){return false}var hasOwnConstructor=hasOwn.call(obj,"constructor");var hasIsPrototypeOf=obj.constructor&&obj.constructor.prototype&&hasOwn.call(obj.constructor.prototype,"isPrototypeOf");if(obj.constructor&&!hasOwnConstructor&&!hasIsPrototypeOf){return false}var key;for(key in obj){}return typeof key==="undefined"||hasOwn.call(obj,key)};var setProperty=function setProperty(target,options){if(defineProperty&&options.name==="__proto__"){defineProperty(target,options.name,{enumerable:true,configurable:true,value:options.newValue,writable:true})}else{target[options.name]=options.newValue}};var getProperty=function getProperty(obj,name){if(name==="__proto__"){if(!hasOwn.call(obj,name)){return void 0}else if(gOPD){return gOPD(obj,name).value}}return obj[name]};var extend$2=function extend(){var options,name,src,copy,copyIsArray,clone;var target=arguments[0];var i=1;var length=arguments.length;var deep=false;if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}if(target==null||_typeof(target)!=="object"&&typeof target!=="function"){target={}}for(;i<length;++i){options=arguments[i];if(options!=null){for(name in options){src=getProperty(target,name);copy=getProperty(options,name);if(target!==copy){if(deep&&copy&&(isPlainObject(copy)||(copyIsArray=isArray$2(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&isArray$2(src)?src:[]}else{clone=src&&isPlainObject(src)?src:{}}setProperty(target,{name:name,newValue:extend(deep,clone,copy)})}else if(typeof copy!=="undefined"){setProperty(target,{name:name,newValue:copy})}}}}}return target};var extend$1=extend$2;function LAA$1(opl,options){options=options||{};this.opl=opl;this.channels=[];this.tracks=[];this.adlib_data=new Int32Array(256);var Midi=options.Midi;if(typeof Midi!="undefined"){this.Midi=Midi;this.midiFile=new Midi.File;this.midiTrack=new Midi.Track;this.midiFile.addTrack(this.midiTrack)}for(var i=0;i<16;i++){this.channels.push(new MidiChannel);this.tracks.push(new MidiTrack);if(typeof Midi!="undefined"){this.channels[i].midiTrack=this.midiTrack}}this.myinsbank=new Array(128);this.smyinsbank=new Array(128);for(var i=0;i<128;i++){this.myinsbank[i]=new Int32Array(16);this.smyinsbank[i]=new Int32Array(16)}this.chp=new Array(18);for(var i=0;i<18;i++){this.chp[i]=new Int32Array(3)}}var laa=LAA$1;extend$1(LAA$1.prototype,{ADL:[65,68,76],LUCAS_STYLE:1,CMF_STYLE:2,MIDI_STYLE:4,SIERRA_STYLE:8,ADLIB_MELODIC:0,ADLIB_RYTHM:1,FILE_LUCAS:"LucasArts AdLib MIDI",adlib_opadd:[0,1,2,8,9,10,16,17,18],ops:[32,32,64,64,96,96,128,128,224,224,192],map_chan:[20,18,21,17],fnums:[363,385,408,432,458,485,514,544,577,611,647,686],percussion_map:[6,7,8,8,7],load:function load(buffer){if(!(buffer instanceof Uint8Array))buffer=new Uint8Array(buffer);this.position=0;if(buffer[0]==this.ADL[0]&&buffer[1]==this.ADL[1]&&buffer[2]==this.ADL[2]){this.type=this.FILE_LUCAS;this.subsongs=1}this.data=buffer;this.rewind(0)},update:function update(){var note,vel,ctrl,nv,x,l;var i=0,j,c;var on,onl,numchan;var ret;if(this.doing==1){for(var curtrack=0;curtrack<16;curtrack++){if(this.tracks[curtrack].on!=0){this.position=this.tracks[curtrack].pos;if(this.type!=this.FILE_SIERRA&&this.type!=this.FILE_ADVSIERRA)this.tracks[curtrack].iwait+=this.getval();else this.tracks[curtrack].iwait+=this.getnext(1);this.tracks[curtrack].pos=this.position}}this.doing=0}this.iwait=0;ret=1;while(this.iwait==0&&ret==1){for(var curtrack=0;curtrack<16;curtrack++){if(this.tracks[curtrack].on!=0&&this.tracks[curtrack].iwait==0&&this.tracks[curtrack].pos<this.tracks[curtrack].tend){this.position=this.tracks[curtrack].pos;var v=this.getnext(1);if(v<128){v=this.tracks[curtrack].pv;this.position--}this.tracks[curtrack].pv=v;var c=v&15;switch(v&240){case 128:var note=this.getnext(1);var vel=this.getnext(1);for(var i=0;i<9;i++){if(this.chp[i][0]==c&&this.chp[i][1]==note){this.midi_fm_endnote(i);this.chp[i][0]=-1}}break;case 144:var note=this.getnext(1);var vel=this.getnext(1);var numchan=this.adlib_mode==this.ADLIB_RYTHM?6:9;if(this.channels[c].on!=0){for(var i=0;i<18;i++){this.chp[i][2]++}if(c<11||this.adlib_mode==this.ADLIB_MELODIC){var j=0;var on=-1;var onl=0;for(var i=0;i<numchan;i++){if(this.chp[i][0]==-1&&this.chp[i][2]>onl){onl=this.chp[i][2];on=i;j=1}}if(on==-1){onl=0;for(var i=0;i<numchan;i++){if(this.chp[i][2]>onl){onl=this.chp[i][2];on=i}}}if(j==0)this.midi_fm_endnote(on)}else on=this.percussion_map[c-11];if(vel!=0&&this.channels[c].inum>=0&&this.channels[c].inum<128){if(this.adlib_mode==this.ADLIB_MELODIC||c<12)this.midi_fm_instrument(on,this.channels[c].ins);else this.midi_fm_percussion(c,this.channels[c].ins);var nv;if((this.adlib_style&this.MIDI_STYLE)!=0){nv=this.channels[c].vol*vel/128|0;if((this.adlib_style&this.LUCAS_STYLE)!=0)nv*=2;if(nv>127)nv=127;nv=this.midi_fm_vol_table[nv];if((this.adlib_style&this.LUCAS_STYLE)!=0)nv=Math.sqrt(nv)*11|0}else nv=vel;this.midi_fm_playnote(on,note+this.channels[c].nshift,nv*2);this.chp[on][0]=c;this.chp[on][1]=note;this.chp[on][2]=0;if(this.midiFile){this.midiTrack.note(c,note,32)}if(this.adlib_mode==this.ADLIB_RYTHM&&c>=11){this.midi_write_adlib(189,this.adlib_data[189]&~(16>>c-11));this.midi_write_adlib(189,this.adlib_data[189]|16>>c-11)}}else{if(vel==0){for(var i=0;i<9;i++){if(this.chp[i][0]==c&&this.chp[i][1]==note){this.midi_fm_endnote(i);this.midiTrack.noteOff(c,note);this.chp[i][0]=-1}}}else{this.chp[on][0]=-1;this.chp[on][2]=0}}}else console.error("channel off",c,this.position);break;case 160:var note=this.getnext(1);var vel=this.getnext(1);break;case 176:var ctrl=this.getnext(1);var vel=this.getnext(1);switch(ctrl){case 7:this.channels[c].vol=vel;break;case 103:if((this.adlib_style&this.CMF_STYLE)!=0){this.adlib_mode=vel;if(this.adlib_mode==this.ADLIB_RYTHM)this.midi_write_adlib(189,this.adlib_data[189]|1<<5);else this.midi_write_adlib(189,this.adlib_data[189]&~(1<<5))}break}break;case 192:var x=this.getnext(1);this.channels[c].inum=x;if(this.midiFile)this.channels[c].midiTrack.instrument(c,x);for(var j=0;j<11;j++){this.channels[c].ins[j]=this.myinsbank[this.channels[c].inum][j]}break;case 208:var x=this.getnext(1);break;case 224:this.getnext(1);this.getnext(1);break;case 240:switch(v){case 240:case 247:var l=this.getval();var t=0;if(this.datalook(this.position+l)==247)t=1;if(this.datalook(this.position)==125&&this.datalook(this.position+1)==16&&this.datalook(this.position+2)<16){this.adlib_style=this.LUCAS_STYLE|this.MIDI_STYLE;this.getnext(1);this.getnext(1);c=this.getnext(1);this.getnext(1);this.channels[c].ins[0]=(this.getnext(1)<<4)+this.getnext(1);this.channels[c].ins[2]=255-((this.getnext(1)<<4)+this.getnext(1)&63);this.channels[c].ins[4]=255-((this.getnext(1)<<4)+this.getnext(1));this.channels[c].ins[6]=255-((this.getnext(1)<<4)+this.getnext(1));this.channels[c].ins[8]=(this.getnext(1)<<4)+this.getnext(1);this.channels[c].ins[1]=(this.getnext(1)<<4)+this.getnext(1);this.channels[c].ins[3]=255-((this.getnext(1)<<4)+this.getnext(1)&63);this.channels[c].ins[5]=255-((this.getnext(1)<<4)+this.getnext(1));this.channels[c].ins[7]=255-((this.getnext(1)<<4)+this.getnext(1));this.channels[c].ins[9]=(this.getnext(1)<<4)+this.getnext(1);i=(this.getnext(1)<<4)+this.getnext(1);this.channels[c].ins[10]=i;i=11;this.getnext(l-26)}else{for(var j=0;j<l;j++){this.getnext(1)}}if(t==1)this.getnext(1);break;case 241:break;case 242:this.getnext(2);break;case 243:this.getnext(1);break;case 244:break;case 245:break;case 246:case 248:case 250:case 251:case 252:if(this.type==this.FILE_SIERRA||this.type==this.FILE_ADVSIERRA){this.tracks[curtrack].tend=this.position}break;case 254:break;case 253:break;case 255:var v=this.getnext(1);var l=this.getval();if(v==81){this.msqtr=this.getnext(l)}else{for(var i=0;i<l;i++){this.getnext(1)}}break}break;default:console.error("!",v)}if(this.position<this.tracks[curtrack].tend){this.tracks[curtrack].iwait=this.type!=this.FILE_SIERRA&&this.type!=this.FILE_ADVSIERRA?this.getval():this.getnext(1)}else this.tracks[curtrack].iwait=0;this.tracks[curtrack].pos=this.position}}ret=0;this.iwait=0;for(var curtrack=0;curtrack<16;curtrack++){if(this.tracks[curtrack].on==1&&this.tracks[curtrack].pos<this.tracks[curtrack].tend){ret=1;break}}if(ret==1){this.iwait=16777215;for(var curtrack=0;curtrack<16;curtrack++){if(this.tracks[curtrack].on==1&&this.tracks[curtrack].pos<this.tracks[curtrack].tend&&this.tracks[curtrack].iwait<this.iwait)this.iwait=this.tracks[curtrack].iwait}}}if(this.iwait!=0&&ret==1){for(var curtrack=0;curtrack<16;curtrack++){if(this.tracks[curtrack].on!=0)this.tracks[curtrack].iwait-=this.iwait}this.fwait=this.iwait/this.deltas*(this.msqtr/1e6)}else this.fwait=1/50;return ret!=0},rewind:function rewind(subsong){this.position=0;this.tins=0;this.adlib_style=this.MIDI_STYLE|this.CMF_STYLE;this.adlib_mode=this.ADLIB_MELODIC;for(var i=0;i<128;i++){for(var j=0;j<14;j++){this.myinsbank[i][j]=this.midi_fm_instruments[i][j]}this.myinsbank[i][14]=0;this.myinsbank[i][15]=0}for(var i=0;i<16;i++){this.channels[i].inum=0;for(var j=0;j<11;j++){this.channels[i].ins[j]=this.myinsbank[this.channels[i].inum][j]}this.channels[i].vol=127;this.channels[i].nshift=-25;this.channels[i].on=1}for(var i=0;i<9;i++){this.chp[i][0]=-1;this.chp[i][2]=0}this.deltas=250;this.msqtr=5e5;this.fwait=1/123;this.iwait=0;this.subsongs=1;for(var i=0;i<16;i++){this.tracks[i].tend=0;this.tracks[i].spos=0;this.tracks[i].pos=0;this.tracks[i].iwait=0;this.tracks[i].on=0;this.tracks[i].pv=0}this.curtrack=0;this.position=0;this.getnext(1);switch(this.type){case this.FILE_LUCAS:this.getnext(24);this.adlib_style=this.LUCAS_STYLE|this.MIDI_STYLE;case this.FILE_MIDI:if(this.type!=this.FILE_LUCAS)this.tins=128;this.getnext(11);this.deltas=this.getnext(2);this.getnext(4);var track=this.tracks[0];track.on=1;track.tend=this.getnext(4);track.spos=this.position;break}for(var i=0;i<16;i++){if(this.tracks[i].on!=0){this.tracks[i].pos=this.tracks[i].spos;this.tracks[i].pv=0;this.tracks[i].iwait=0}}this.doing=1;this.midi_fm_reset()},refresh:function refresh(){return Math.min(this.fwait,100)},datalook:function datalook(pos){return this.position<0||this.position>=this.data.length?0:this.data[pos]},getnexti:function getnexti(num){var v=0;for(var i=0;i<num;i++){v+=this.datalook(this.position)<<8*i;this.position++}return v},getnext:function getnext(num){var v=0;for(var i=0;i<num;i++){v<<=8;v+=this.datalook(this.position);this.position++}return v},getval:function getval(){var b=this.getnext(1);var v=b&127;while((b&128)!=0){b=this.getnext(1);v=(v<<7)+(b&127)}return v},midi_write_adlib:function midi_write_adlib(r,v){this.opl.write(0,r,v);this.adlib_data[r]=v},midi_fm_instrument:function midi_fm_instrument(voice,inst){this.midi_write_adlib(32+this.adlib_opadd[voice],inst[0]);this.midi_write_adlib(35+this.adlib_opadd[voice],inst[1]);if((this.adlib_style&this.LUCAS_STYLE)!=0){this.midi_write_adlib(67+this.adlib_opadd[voice],63);if((inst[10]&1)==0)this.midi_write_adlib(64+this.adlib_opadd[voice],inst[2]);else this.midi_write_adlib(64+this.adlib_opadd[voice],63)}this.midi_write_adlib(96+this.adlib_opadd[voice],inst[4]);this.midi_write_adlib(99+this.adlib_opadd[voice],inst[5]);this.midi_write_adlib(128+this.adlib_opadd[voice],inst[6]);this.midi_write_adlib(131+this.adlib_opadd[voice],inst[7]);this.midi_write_adlib(224+this.adlib_opadd[voice],inst[8]);this.midi_write_adlib(227+this.adlib_opadd[voice],inst[9])},midi_fm_percussion:function midi_fm_percussion(ch,inst){var opadd=this.map_chan[ch-12];this.midi_write_adlib(32+opadd,inst[0]);this.midi_write_adlib(64+opadd,inst[2]);this.midi_write_adlib(96+opadd,inst[4]);this.midi_write_adlib(128+opadd,inst[6]);this.midi_write_adlib(224+opadd,inst[8])},midi_fm_volume:function midi_fm_volume(voice,volume){var vol=volume>>2;if((this.adlib_data[192+voice]&1)==1)this.midi_write_adlib(64+this.adlib_opadd[voice],63-vol|this.adlib_data[64+this.adlib_opadd[voice]]&192);this.midi_write_adlib(67+this.adlib_opadd[voice],63-vol|this.adlib_data[67+this.adlib_opadd[voice]]&192)},midi_fm_playnote:function midi_fm_playnote(voice,note,volume){if(note<0)note=12-note%12;var freq=this.fnums[note%12];var oct=note/12|0;this.midi_fm_volume(voice,volume);this.midi_write_adlib(160+voice,freq&255);var c=((freq&768)>>8)+(oct<<2)+(this.adlib_mode==this.ADLIB_MELODIC||voice<6?1<<5:0);this.midi_write_adlib(176+voice,c)},midi_fm_endnote:function midi_fm_endnote(voice){this.midi_write_adlib(176+voice,this.adlib_data[176+voice]&255-32)},midi_fm_reset:function midi_fm_reset(){for(var i=0;i<256;i++){this.midi_write_adlib(i,0)}for(var i=192;i<=200;i++){this.midi_write_adlib(i,240)}this.midi_write_adlib(1,32);this.midi_write_adlib(189,192)},midi_fm_instruments:[[33,33,143,12,242,242,69,118,0,0,8,0,0,0],[49,33,75,9,242,242,84,86,0,0,8,0,0,0],[49,33,73,9,242,242,85,118,0,0,8,0,0,0],[177,97,14,9,242,243,59,11,0,0,6,0,0,0],[1,33,87,9,241,241,56,40,0,0,0,0,0,0],[1,33,147,9,241,241,56,40,0,0,0,0,0,0],[33,54,128,23,162,241,1,213,0,0,8,0,0,0],[1,1,146,9,194,194,168,88,0,0,10,0,0,0],[12,129,92,9,246,243,84,181,0,0,0,0,0,0],[7,17,151,137,246,245,50,17,0,0,2,0,0,0],[23,1,33,9,86,246,4,4,0,0,2,0,0,0],[24,129,98,9,243,242,230,246,0,0,0,0,0,0],[24,33,35,9,247,229,85,216,0,0,0,0,0,0],[21,1,145,9,246,246,166,230,0,0,4,0,0,0],[69,129,89,137,211,163,130,227,0,0,12,0,0,0],[3,129,73,137,116,179,85,5,1,0,4,0,0,0],[113,49,146,9,246,241,20,7,0,0,2,0,0,0],[114,48,20,9,199,199,88,8,0,0,2,0,0,0],[112,177,68,9,170,138,24,8,0,0,4,0,0,0],[35,177,147,9,151,85,35,20,1,0,4,0,0,0],[97,177,19,137,151,85,4,4,1,0,0,0,0,0],[36,177,72,9,152,70,42,26,1,0,12,0,0,0],[97,33,19,9,145,97,6,7,1,0,10,0,0,0],[33,161,19,146,113,97,6,7,0,0,6,0,0,0],[2,65,156,137,243,243,148,200,1,0,12,0,0,0],[3,17,84,9,243,241,154,231,1,0,12,0,0,0],[35,33,95,9,241,242,58,248,0,0,0,0,0,0],[3,33,135,137,246,243,34,248,1,0,6,0,0,0],[3,33,71,9,249,246,84,58,0,0,0,0,0,0],[35,33,74,14,145,132,65,25,1,0,8,0,0,0],[35,33,74,9,149,148,25,25,1,0,8,0,0,0],[9,132,161,137,32,209,79,248,0,0,8,0,0,0],[33,162,30,9,148,195,6,166,0,0,2,0,0,0],[49,49,18,9,241,241,40,24,0,0,10,0,0,0],[49,49,141,9,241,241,232,120,0,0,10,0,0,0],[49,50,91,9,81,113,40,72,0,0,12,0,0,0],[1,33,139,73,161,242,154,223,0,0,8,0,0,0],[33,33,139,17,162,161,22,223,0,0,8,0,0,0],[49,49,139,9,244,241,232,120,0,0,10,0,0,0],[49,49,18,9,241,241,40,24,0,0,10,0,0,0],[49,33,21,9,221,86,19,38,1,0,8,0,0,0],[49,33,22,9,221,102,19,6,1,0,8,0,0,0],[113,49,73,9,209,97,28,12,1,0,8,0,0,0],[33,35,77,137,113,114,18,6,1,0,2,0,0,0],[241,225,64,9,241,111,33,22,1,0,2,0,0,0],[2,1,26,137,245,133,117,53,1,0,0,0,0,0],[2,1,29,137,245,243,117,244,1,0,0,0,0,0],[16,17,65,9,245,242,5,195,1,0,2,0,0,0],[33,162,155,10,177,114,37,8,1,0,14,0,0,0],[161,33,152,9,127,63,3,7,1,1,0,0,0,0],[161,97,147,9,193,79,18,5,0,0,10,0,0,0],[33,97,24,9,193,79,34,5,0,0,12,0,0,0],[49,114,91,140,244,138,21,5,0,0,0,0,0,0],[161,97,144,9,116,113,57,103,0,0,0,0,0,0],[113,114,87,9,84,122,5,5,0,0,12,0,0,0],[144,65,0,9,84,165,99,69,0,0,8,0,0,0],[33,33,146,10,133,143,23,9,0,0,12,0,0,0],[33,33,148,14,117,143,23,9,0,0,12,0,0,0],[33,97,148,9,118,130,21,55,0,0,12,0,0,0],[49,33,67,9,158,98,23,44,1,1,2,0,0,0],[33,33,155,9,97,127,106,10,0,0,2,0,0,0],[97,34,138,15,117,116,31,15,0,0,8,0,0,0],[161,33,134,140,114,113,85,24,1,0,0,0,0,0],[33,33,77,9,84,166,60,28,0,0,8,0,0,0],[49,97,143,9,147,114,2,11,1,0,8,0,0,0],[49,97,142,9,147,114,3,9,1,0,8,0,0,0],[49,97,145,9,147,130,3,9,1,0,10,0,0,0],[49,97,142,9,147,114,15,15,1,0,10,0,0,0],[33,33,75,9,170,143,22,10,1,0,8,0,0,0],[49,33,144,9,126,139,23,12,1,1,6,0,0,0],[49,50,129,9,117,97,25,25,1,0,0,0,0,0],[50,33,144,9,155,114,33,23,0,0,4,0,0,0],[225,225,31,9,133,101,95,26,0,0,0,0,0,0],[225,225,70,9,136,101,95,26,0,0,0,0,0,0],[161,33,156,9,117,117,31,10,0,0,2,0,0,0],[49,33,139,9,132,101,88,26,0,0,0,0,0,0],[225,161,76,9,102,101,86,38,0,0,0,0,0,0],[98,161,203,9,118,85,70,54,0,0,0,0,0,0],[98,161,162,9,87,86,7,7,0,0,11,0,0,0],[98,161,156,9,119,118,7,7,0,0,11,0,0,0],[34,33,89,9,255,255,3,15,2,0,0,0,0,0],[33,33,14,9,255,255,15,15,1,1,0,0,0,0],[34,33,70,137,134,100,85,24,0,0,0,0,0,0],[33,161,69,9,102,150,18,10,0,0,0,0,0,0],[33,34,139,9,146,145,42,42,1,0,0,0,0,0],[162,97,158,73,223,111,5,7,0,0,2,0,0,0],[32,96,26,9,239,143,1,6,0,2,0,0,0,0],[33,33,143,134,241,244,41,9,0,0,10,0,0,0],[119,161,165,9,83,160,148,5,0,0,2,0,0,0],[97,177,31,137,168,37,17,3,0,0,10,0,0,0],[97,97,23,9,145,85,52,22,0,0,12,0,0,0],[113,114,93,9,84,106,1,3,0,0,0,0,0,0],[33,162,151,9,33,66,67,53,0,0,8,0,0,0],[161,33,28,9,161,49,119,71,1,1,0,0,0,0],[33,97,137,12,17,66,51,37,0,0,10,0,0,0],[161,33,21,9,17,207,71,7,1,0,0,0,0,0],[58,81,206,9,248,134,246,2,0,0,2,0,0,0],[33,33,21,9,33,65,35,19,1,0,0,0,0,0],[6,1,91,9,116,165,149,114,0,0,0,0,0,0],[34,97,146,140,177,242,129,38,0,0,12,0,0,0],[65,66,77,9,241,242,81,245,1,0,0,0,0,0],[97,163,148,137,17,17,81,19,1,0,6,0,0,0],[97,161,140,137,17,29,49,3,0,0,6,0,0,0],[164,97,76,9,243,129,115,35,1,0,4,0,0,0],[2,7,133,12,210,242,83,246,0,1,0,0,0,0],[17,19,12,137,163,162,17,229,1,0,0,0,0,0],[17,17,6,9,246,242,65,230,1,2,4,0,0,0],[147,145,145,9,212,235,50,17,0,1,8,0,0,0],[4,1,79,9,250,194,86,5,0,0,12,0,0,0],[33,34,73,9,124,111,32,12,0,1,6,0,0,0],[49,33,133,9,221,86,51,22,1,0,10,0,0,0],[32,33,4,138,218,143,5,11,2,0,6,0,0,0],[5,3,106,137,241,195,229,229,0,0,6,0,0,0],[7,2,21,9,236,248,38,22,0,0,10,0,0,0],[5,1,157,9,103,223,53,5,0,0,8,0,0,0],[24,18,150,9,250,248,40,229,0,0,10,0,0,0],[16,0,134,12,168,250,7,3,0,0,6,0,0,0],[17,16,65,12,248,243,71,3,2,0,4,0,0,0],[1,16,142,9,241,243,6,2,2,0,14,0,0,0],[14,192,0,9,31,31,0,255,0,3,14,0,0,0],[6,3,128,145,248,86,36,132,0,2,14,0,0,0],[14,208,0,14,248,52,0,4,0,3,14,0,0,0],[14,192,0,9,246,31,0,2,0,3,14,0,0,0],[213,218,149,73,55,86,163,55,0,0,0,0,0,0],[53,20,92,17,178,244,97,21,2,0,10,0,0,0],[14,208,0,9,246,79,0,245,0,3,14,0,0,0],[38,228,0,9,255,18,1,22,0,1,14,0,0,0],[0,0,0,9,243,246,240,201,0,2,14,0,0,0]],midi_fm_vol_table:[0,11,16,19,22,25,27,29,32,33,35,37,39,40,42,43,45,46,48,49,50,51,53,54,55,56,57,58,59,60,61,62,64,64,65,66,67,68,69,70,71,72,73,74,75,75,76,77,78,79,80,80,81,82,83,83,84,85,86,86,87,88,89,89,90,91,91,92,93,93,94,95,96,96,97,97,98,99,99,100,101,101,102,103,103,104,104,105,106,106,107,107,108,109,109,110,110,111,112,112,113,113,114,114,115,115,116,117,117,118,118,119,119,120,120,121,121,122,122,123,123,124,124,125,125,126,126,127]});function MidiChannel(){this.ins=new Int32Array(11)}function MidiTrack(){}var global$1=typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{};var lookup=[];var revLookup=[];var Arr=typeof Uint8Array!=="undefined"?Uint8Array:Array;var inited=false;function init(){inited=true;var code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var i=0,len=code.length;i<len;++i){lookup[i]=code[i];revLookup[code.charCodeAt(i)]=i}revLookup["-".charCodeAt(0)]=62;revLookup["_".charCodeAt(0)]=63}function toByteArray(b64){if(!inited){init()}var i,j,l,tmp,placeHolders,arr;var len=b64.length;if(len%4>0){throw new Error("Invalid string. Length must be a multiple of 4")}placeHolders=b64[len-2]==="="?2:b64[len-1]==="="?1:0;arr=new Arr(len*3/4-placeHolders);l=placeHolders>0?len-4:len;var L=0;for(i=0,j=0;i<l;i+=4,j+=3){tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)];arr[L++]=tmp>>16&255;arr[L++]=tmp>>8&255;arr[L++]=tmp&255}if(placeHolders===2){tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4;arr[L++]=tmp&255}else if(placeHolders===1){tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2;arr[L++]=tmp>>8&255;arr[L++]=tmp&255}return arr}function tripletToBase64(num){return lookup[num>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[num&63]}function encodeChunk(uint8,start,end){var tmp;var output=[];for(var i=start;i<end;i+=3){tmp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2];output.push(tripletToBase64(tmp))}return output.join("")}function fromByteArray(uint8){if(!inited){init()}var tmp;var len=uint8.length;var extraBytes=len%3;var output="";var parts=[];var maxChunkLength=16383;for(var i=0,len2=len-extraBytes;i<len2;i+=maxChunkLength){parts.push(encodeChunk(uint8,i,i+maxChunkLength>len2?len2:i+maxChunkLength))}if(extraBytes===1){tmp=uint8[len-1];output+=lookup[tmp>>2];output+=lookup[tmp<<4&63];output+="=="}else if(extraBytes===2){tmp=(uint8[len-2]<<8)+uint8[len-1];output+=lookup[tmp>>10];output+=lookup[tmp>>4&63];output+=lookup[tmp<<2&63];output+="="}parts.push(output);return parts.join("")}function read(buffer,offset,isLE,mLen,nBytes){var e,m;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var nBits=-7;var i=isLE?nBytes-1:0;var d=isLE?-1:1;var s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8){}m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8){}if(e===0){e=1-eBias}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity}else{m=m+Math.pow(2,mLen);e=e-eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)}function write(buffer,value,offset,isLE,mLen,nBytes){var e,m,c;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0;var i=isLE?0:nBytes-1;var d=isLE?1:-1;var s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2}if(e+eBias>=1){value+=rt/c}else{value+=rt*Math.pow(2,1-eBias)}if(value*c>=2){e++;c/=2}if(e+eBias>=eMax){m=0;e=eMax}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0}}for(;mLen>=8;buffer[offset+i]=m&255,i+=d,m/=256,mLen-=8){}e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&255,i+=d,e/=256,eLen-=8){}buffer[offset+i-d]|=s*128}var toString={}.toString;var isArray$1=Array.isArray||function(arr){return toString.call(arr)=="[object Array]"};var INSPECT_MAX_BYTES=50;Buffer.TYPED_ARRAY_SUPPORT=global$1.TYPED_ARRAY_SUPPORT!==undefined?global$1.TYPED_ARRAY_SUPPORT:true;kMaxLength();function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function createBuffer(that,length){if(kMaxLength()<length){throw new RangeError("Invalid typed array length")}if(Buffer.TYPED_ARRAY_SUPPORT){that=new Uint8Array(length);that.__proto__=Buffer.prototype}else{if(that===null){that=new Buffer(length)}that.length=length}return that}function Buffer(arg,encodingOrOffset,length){if(!Buffer.TYPED_ARRAY_SUPPORT&&!(this instanceof Buffer)){return new Buffer(arg,encodingOrOffset,length)}if(typeof arg==="number"){if(typeof encodingOrOffset==="string"){throw new Error("If encoding is specified then the first argument must be a string")}return allocUnsafe(this,arg)}return from(this,arg,encodingOrOffset,length)}Buffer.poolSize=8192;Buffer._augment=function(arr){arr.__proto__=Buffer.prototype;return arr};function from(that,value,encodingOrOffset,length){if(typeof value==="number"){throw new TypeError('"value" argument must not be a number')}if(typeof ArrayBuffer!=="undefined"&&value instanceof ArrayBuffer){return fromArrayBuffer(that,value,encodingOrOffset,length)}if(typeof value==="string"){return fromString(that,value,encodingOrOffset)}return fromObject(that,value)}Buffer.from=function(value,encodingOrOffset,length){return from(null,value,encodingOrOffset,length)};if(Buffer.TYPED_ARRAY_SUPPORT){Buffer.prototype.__proto__=Uint8Array.prototype;Buffer.__proto__=Uint8Array;if(typeof Symbol!=="undefined"&&Symbol.species&&Buffer[Symbol.species]===Buffer);}function assertSize(size){if(typeof size!=="number"){throw new TypeError('"size" argument must be a number')}else if(size<0){throw new RangeError('"size" argument must not be negative')}}function alloc(that,size,fill,encoding){assertSize(size);if(size<=0){return createBuffer(that,size)}if(fill!==undefined){return typeof encoding==="string"?createBuffer(that,size).fill(fill,encoding):createBuffer(that,size).fill(fill)}return createBuffer(that,size)}Buffer.alloc=function(size,fill,encoding){return alloc(null,size,fill,encoding)};function allocUnsafe(that,size){assertSize(size);that=createBuffer(that,size<0?0:checked(size)|0);if(!Buffer.TYPED_ARRAY_SUPPORT){for(var i=0;i<size;++i){that[i]=0}}return that}Buffer.allocUnsafe=function(size){return allocUnsafe(null,size)};Buffer.allocUnsafeSlow=function(size){return allocUnsafe(null,size)};function fromString(that,string,encoding){if(typeof encoding!=="string"||encoding===""){encoding="utf8"}if(!Buffer.isEncoding(encoding)){throw new TypeError('"encoding" must be a valid string encoding')}var length=byteLength(string,encoding)|0;that=createBuffer(that,length);var actual=that.write(string,encoding);if(actual!==length){that=that.slice(0,actual)}return that}function fromArrayLike(that,array){var length=array.length<0?0:checked(array.length)|0;that=createBuffer(that,length);for(var i=0;i<length;i+=1){that[i]=array[i]&255}return that}function fromArrayBuffer(that,array,byteOffset,length){array.byteLength;if(byteOffset<0||array.byteLength<byteOffset){throw new RangeError("'offset' is out of bounds")}if(array.byteLength<byteOffset+(length||0)){throw new RangeError("'length' is out of bounds")}if(byteOffset===undefined&&length===undefined){array=new Uint8Array(array)}else if(length===undefined){array=new Uint8Array(array,byteOffset)}else{array=new Uint8Array(array,byteOffset,length)}if(Buffer.TYPED_ARRAY_SUPPORT){that=array;that.__proto__=Buffer.prototype}else{that=fromArrayLike(that,array)}return that}function fromObject(that,obj){if(internalIsBuffer(obj)){var len=checked(obj.length)|0;that=createBuffer(that,len);if(that.length===0){return that}obj.copy(that,0,0,len);return that}if(obj){if(typeof ArrayBuffer!=="undefined"&&obj.buffer instanceof ArrayBuffer||"length"in obj){if(typeof obj.length!=="number"||isnan(obj.length)){return createBuffer(that,0)}return fromArrayLike(that,obj)}if(obj.type==="Buffer"&&isArray$1(obj.data)){return fromArrayLike(that,obj.data)}}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}function checked(length){if(length>=kMaxLength()){throw new RangeError("Attempt to allocate Buffer larger than maximum "+"size: 0x"+kMaxLength().toString(16)+" bytes")}return length|0}Buffer.isBuffer=isBuffer;function internalIsBuffer(b){return!!(b!=null&&b._isBuffer)}Buffer.compare=function compare(a,b){if(!internalIsBuffer(a)||!internalIsBuffer(b)){throw new TypeError("Arguments must be Buffers")}if(a===b)return 0;var x=a.length;var y=b.length;for(var i=0,len=Math.min(x,y);i<len;++i){if(a[i]!==b[i]){x=a[i];y=b[i];break}}if(x<y)return-1;if(y<x)return 1;return 0};Buffer.isEncoding=function isEncoding(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return true;default:return false}};Buffer.concat=function concat(list,length){if(!isArray$1(list)){throw new TypeError('"list" argument must be an Array of Buffers')}if(list.length===0){return Buffer.alloc(0)}var i;if(length===undefined){length=0;for(i=0;i<list.length;++i){length+=list[i].length}}var buffer=Buffer.allocUnsafe(length);var pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(!internalIsBuffer(buf)){throw new TypeError('"list" argument must be an Array of Buffers')}buf.copy(buffer,pos);pos+=buf.length}return buffer};function byteLength(string,encoding){if(internalIsBuffer(string)){return string.length}if(typeof ArrayBuffer!=="undefined"&&typeof ArrayBuffer.isView==="function"&&(ArrayBuffer.isView(string)||string instanceof ArrayBuffer)){return string.byteLength}if(typeof string!=="string"){string=""+string}var len=string.length;if(len===0)return 0;var loweredCase=false;for(;;){switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":case undefined:return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return len*2;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase();loweredCase=true}}}Buffer.byteLength=byteLength;function slowToString(encoding,start,end){var loweredCase=false;if(start===undefined||start<0){start=0}if(start>this.length){return""}if(end===undefined||end>this.length){end=this.length}if(end<=0){return""}end>>>=0;start>>>=0;if(end<=start){return""}if(!encoding)encoding="utf8";while(true){switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase();loweredCase=true}}}Buffer.prototype._isBuffer=true;function swap(b,n,m){var i=b[n];b[n]=b[m];b[m]=i}Buffer.prototype.swap16=function swap16(){var len=this.length;if(len%2!==0){throw new RangeError("Buffer size must be a multiple of 16-bits")}for(var i=0;i<len;i+=2){swap(this,i,i+1)}return this};Buffer.prototype.swap32=function swap32(){var len=this.length;if(len%4!==0){throw new RangeError("Buffer size must be a multiple of 32-bits")}for(var i=0;i<len;i+=4){swap(this,i,i+3);swap(this,i+1,i+2)}return this};Buffer.prototype.swap64=function swap64(){var len=this.length;if(len%8!==0){throw new RangeError("Buffer size must be a multiple of 64-bits")}for(var i=0;i<len;i+=8){swap(this,i,i+7);swap(this,i+1,i+6);swap(this,i+2,i+5);swap(this,i+3,i+4)}return this};Buffer.prototype.toString=function toString(){var length=this.length|0;if(length===0)return"";if(arguments.length===0)return utf8Slice(this,0,length);return slowToString.apply(this,arguments)};Buffer.prototype.equals=function equals(b){if(!internalIsBuffer(b))throw new TypeError("Argument must be a Buffer");if(this===b)return true;return Buffer.compare(this,b)===0};Buffer.prototype.inspect=function inspect(){var str="";var max=INSPECT_MAX_BYTES;if(this.length>0){str=this.toString("hex",0,max).match(/.{2}/g).join(" ");if(this.length>max)str+=" ... "}return"<Buffer "+str+">"};Buffer.prototype.compare=function compare(target,start,end,thisStart,thisEnd){if(!internalIsBuffer(target)){throw new TypeError("Argument must be a Buffer")}if(start===undefined){start=0}if(end===undefined){end=target?target.length:0}if(thisStart===undefined){thisStart=0}if(thisEnd===undefined){thisEnd=this.length}if(start<0||end>target.length||thisStart<0||thisEnd>this.length){throw new RangeError("out of range index")}if(thisStart>=thisEnd&&start>=end){return 0}if(thisStart>=thisEnd){return-1}if(start>=end){return 1}start>>>=0;end>>>=0;thisStart>>>=0;thisEnd>>>=0;if(this===target)return 0;var x=thisEnd-thisStart;var y=end-start;var len=Math.min(x,y);var thisCopy=this.slice(thisStart,thisEnd);var targetCopy=target.slice(start,end);for(var i=0;i<len;++i){if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i];y=targetCopy[i];break}}if(x<y)return-1;if(y<x)return 1;return 0};function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(buffer.length===0)return-1;if(typeof byteOffset==="string"){encoding=byteOffset;byteOffset=0}else if(byteOffset>2147483647){byteOffset=2147483647}else if(byteOffset<-2147483648){byteOffset=-2147483648}byteOffset=+byteOffset;if(isNaN(byteOffset)){byteOffset=dir?0:buffer.length-1}if(byteOffset<0)byteOffset=buffer.length+byteOffset;if(byteOffset>=buffer.length){if(dir)return-1;else byteOffset=buffer.length-1}else if(byteOffset<0){if(dir)byteOffset=0;else return-1}if(typeof val==="string"){val=Buffer.from(val,encoding)}if(internalIsBuffer(val)){if(val.length===0){return-1}return arrayIndexOf(buffer,val,byteOffset,encoding,dir)}else if(typeof val==="number"){val=val&255;if(Buffer.TYPED_ARRAY_SUPPORT&&typeof Uint8Array.prototype.indexOf==="function"){if(dir){return Uint8Array.prototype.indexOf.call(buffer,val,byteOffset)}else{return Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset)}}return arrayIndexOf(buffer,[val],byteOffset,encoding,dir)}throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){var indexSize=1;var arrLength=arr.length;var valLength=val.length;if(encoding!==undefined){encoding=String(encoding).toLowerCase();if(encoding==="ucs2"||encoding==="ucs-2"||encoding==="utf16le"||encoding==="utf-16le"){if(arr.length<2||val.length<2){return-1}indexSize=2;arrLength/=2;valLength/=2;byteOffset/=2}}function read(buf,i){if(indexSize===1){return buf[i]}else{return buf.readUInt16BE(i*indexSize)}}var i;if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++){if(read(arr,i)===read(val,foundIndex===-1?0:i-foundIndex)){if(foundIndex===-1)foundIndex=i;if(i-foundIndex+1===valLength)return foundIndex*indexSize}else{if(foundIndex!==-1)i-=i-foundIndex;foundIndex=-1}}}else{if(byteOffset+valLength>arrLength)byteOffset=arrLength-valLength;for(i=byteOffset;i>=0;i--){var found=true;for(var j=0;j<valLength;j++){if(read(arr,i+j)!==read(val,j)){found=false;break}}if(found)return i}}return-1}Buffer.prototype.includes=function includes(val,byteOffset,encoding){return this.indexOf(val,byteOffset,encoding)!==-1};Buffer.prototype.indexOf=function indexOf(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,true)};Buffer.prototype.lastIndexOf=function lastIndexOf(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,false)};function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}var strLen=string.length;if(strLen%2!==0)throw new TypeError("Invalid hex string");if(length>strLen/2){length=strLen/2}for(var i=0;i<length;++i){var parsed=parseInt(string.substr(i*2,2),16);if(isNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(asciiToBytes(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length)}Buffer.prototype.write=function write(string,offset,length,encoding){if(offset===undefined){encoding="utf8";length=this.length;offset=0}else if(length===undefined&&typeof offset==="string"){encoding=offset;length=this.length;offset=0}else if(isFinite(offset)){offset=offset|0;if(isFinite(length)){length=length|0;if(encoding===undefined)encoding="utf8"}else{encoding=length;length=undefined}}else{throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported")}var remaining=this.length-offset;if(length===undefined||length>remaining)length=remaining;if(string.length>0&&(length<0||offset<0)||offset>this.length){throw new RangeError("Attempt to write outside buffer bounds")}if(!encoding)encoding="utf8";var loweredCase=false;for(;;){switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase();loweredCase=true}}};Buffer.prototype.toJSON=function toJSON(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function base64Slice(buf,start,end){if(start===0&&end===buf.length){return fromByteArray(buf)}else{return fromByteArray(buf.slice(start,end))}}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);var res=[];var i=start;while(i<end){var firstByte=buf[i];var codePoint=null;var bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(i+bytesPerSequence<=end){var secondByte,thirdByte,fourthByte,tempCodePoint;switch(bytesPerSequence){case 1:if(firstByte<128){codePoint=firstByte}break;case 2:secondByte=buf[i+1];if((secondByte&192)===128){tempCodePoint=(firstByte&31)<<6|secondByte&63;if(tempCodePoint>127){codePoint=tempCodePoint}}break;case 3:secondByte=buf[i+1];thirdByte=buf[i+2];if((secondByte&192)===128&&(thirdByte&192)===128){tempCodePoint=(firstByte&15)<<12|(secondByte&63)<<6|thirdByte&63;if(tempCodePoint>2047&&(tempCodePoint<55296||tempCodePoint>57343)){codePoint=tempCodePoint}}break;case 4:secondByte=buf[i+1];thirdByte=buf[i+2];fourthByte=buf[i+3];if((secondByte&192)===128&&(thirdByte&192)===128&&(fourthByte&192)===128){tempCodePoint=(firstByte&15)<<18|(secondByte&63)<<12|(thirdByte&63)<<6|fourthByte&63;if(tempCodePoint>65535&&tempCodePoint<1114112){codePoint=tempCodePoint}}}}if(codePoint===null){codePoint=65533;bytesPerSequence=1}else if(codePoint>65535){codePoint-=65536;res.push(codePoint>>>10&1023|55296);codePoint=56320|codePoint&1023}res.push(codePoint);i+=bytesPerSequence}return decodeCodePointsArray(res)}var MAX_ARGUMENTS_LENGTH=4096;function decodeCodePointsArray(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH){return String.fromCharCode.apply(String,codePoints)}var res="";var i=0;while(i<len){res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH))}return res}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i){ret+=String.fromCharCode(buf[i]&127)}return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i){ret+=String.fromCharCode(buf[i])}return ret}function hexSlice(buf,start,end){var len=buf.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out="";for(var i=start;i<end;++i){out+=toHex(buf[i])}return out}function utf16leSlice(buf,start,end){var bytes=buf.slice(start,end);var res="";for(var i=0;i<bytes.length;i+=2){res+=String.fromCharCode(bytes[i]+bytes[i+1]*256)}return res}Buffer.prototype.slice=function slice(start,end){var len=this.length;start=~~start;end=end===undefined?len:~~end;if(start<0){start+=len;if(start<0)start=0}else if(start>len){start=len}if(end<0){end+=len;if(end<0)end=0}else if(end>len){end=len}if(end<start)end=start;var newBuf;if(Buffer.TYPED_ARRAY_SUPPORT){newBuf=this.subarray(start,end);newBuf.__proto__=Buffer.prototype}else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,undefined);for(var i=0;i<sliceLen;++i){newBuf[i]=this[i+start]}}return newBuf};function checkOffset(offset,ext,length){if(offset%1!==0||offset<0)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}Buffer.prototype.readUIntLE=function readUIntLE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=256)){val+=this[offset+i]*mul}return val};Buffer.prototype.readUIntBE=function readUIntBE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert){checkOffset(offset,byteLength,this.length)}var val=this[offset+--byteLength];var mul=1;while(byteLength>0&&(mul*=256)){val+=this[offset+--byteLength]*mul}return val};Buffer.prototype.readUInt8=function readUInt8(offset,noAssert){if(!noAssert)checkOffset(offset,1,this.length);return this[offset]};Buffer.prototype.readUInt16LE=function readUInt16LE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);return this[offset]|this[offset+1]<<8};Buffer.prototype.readUInt16BE=function readUInt16BE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);return this[offset]<<8|this[offset+1]};Buffer.prototype.readUInt32LE=function readUInt32LE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+this[offset+3]*16777216};Buffer.prototype.readUInt32BE=function readUInt32BE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]*16777216+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])};Buffer.prototype.readIntLE=function readIntLE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=256)){val+=this[offset+i]*mul}mul*=128;if(val>=mul)val-=Math.pow(2,8*byteLength);return val};Buffer.prototype.readIntBE=function readIntBE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var i=byteLength;var mul=1;var val=this[offset+--i];while(i>0&&(mul*=256)){val+=this[offset+--i]*mul}mul*=128;if(val>=mul)val-=Math.pow(2,8*byteLength);return val};Buffer.prototype.readInt8=function readInt8(offset,noAssert){if(!noAssert)checkOffset(offset,1,this.length);if(!(this[offset]&128))return this[offset];return(255-this[offset]+1)*-1};Buffer.prototype.readInt16LE=function readInt16LE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return val&32768?val|4294901760:val};Buffer.prototype.readInt16BE=function readInt16BE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return val&32768?val|4294901760:val};Buffer.prototype.readInt32LE=function readInt32LE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24};Buffer.prototype.readInt32BE=function readInt32BE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]};Buffer.prototype.readFloatLE=function readFloatLE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return read(this,offset,true,23,4)};Buffer.prototype.readFloatBE=function readFloatBE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return read(this,offset,false,23,4)};Buffer.prototype.readDoubleLE=function readDoubleLE(offset,noAssert){if(!noAssert)checkOffset(offset,8,this.length);return read(this,offset,true,52,8)};Buffer.prototype.readDoubleBE=function readDoubleBE(offset,noAssert){if(!noAssert)checkOffset(offset,8,this.length);return read(this,offset,false,52,8)};function checkInt(buf,value,offset,ext,max,min){if(!internalIsBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}Buffer.prototype.writeUIntLE=function writeUIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;byteLength=byteLength|0;if(!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var mul=1;var i=0;this[offset]=value&255;while(++i<byteLength&&(mul*=256)){this[offset+i]=value/mul&255}return offset+byteLength};Buffer.prototype.writeUIntBE=function writeUIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;byteLength=byteLength|0;if(!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var i=byteLength-1;var mul=1;this[offset+i]=value&255;while(--i>=0&&(mul*=256)){this[offset+i]=value/mul&255}return offset+byteLength};Buffer.prototype.writeUInt8=function writeUInt8(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,1,255,0);if(!Buffer.TYPED_ARRAY_SUPPORT)value=Math.floor(value);this[offset]=value&255;return offset+1};function objectWriteUInt16(buf,value,offset,littleEndian){if(value<0)value=65535+value+1;for(var i=0,j=Math.min(buf.length-offset,2);i<j;++i){buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>(littleEndian?i:1-i)*8}}Buffer.prototype.writeUInt16LE=function writeUInt16LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,65535,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&255;this[offset+1]=value>>>8}else{objectWriteUInt16(this,value,offset,true)}return offset+2};Buffer.prototype.writeUInt16BE=function writeUInt16BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,65535,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>8;this[offset+1]=value&255}else{objectWriteUInt16(this,value,offset,false)}return offset+2};function objectWriteUInt32(buf,value,offset,littleEndian){if(value<0)value=4294967295+value+1;for(var i=0,j=Math.min(buf.length-offset,4);i<j;++i){buf[offset+i]=value>>>(littleEndian?i:3-i)*8&255}}Buffer.prototype.writeUInt32LE=function writeUInt32LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,4294967295,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset+3]=value>>>24;this[offset+2]=value>>>16;this[offset+1]=value>>>8;this[offset]=value&255}else{objectWriteUInt32(this,value,offset,true)}return offset+4};Buffer.prototype.writeUInt32BE=function writeUInt32BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,4294967295,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&255}else{objectWriteUInt32(this,value,offset,false)}return offset+4};Buffer.prototype.writeIntLE=function writeIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0;var mul=1;var sub=0;this[offset]=value&255;while(++i<byteLength&&(mul*=256)){if(value<0&&sub===0&&this[offset+i-1]!==0){sub=1}this[offset+i]=(value/mul>>0)-sub&255}return offset+byteLength};Buffer.prototype.writeIntBE=function writeIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1;var mul=1;var sub=0;this[offset+i]=value&255;while(--i>=0&&(mul*=256)){if(value<0&&sub===0&&this[offset+i+1]!==0){sub=1}this[offset+i]=(value/mul>>0)-sub&255}return offset+byteLength};Buffer.prototype.writeInt8=function writeInt8(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,1,127,-128);if(!Buffer.TYPED_ARRAY_SUPPORT)value=Math.floor(value);if(value<0)value=255+value+1;this[offset]=value&255;return offset+1};Buffer.prototype.writeInt16LE=function writeInt16LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,32767,-32768);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&255;this[offset+1]=value>>>8}else{objectWriteUInt16(this,value,offset,true)}return offset+2};Buffer.prototype.writeInt16BE=function writeInt16BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,32767,-32768);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>8;this[offset+1]=value&255}else{objectWriteUInt16(this,value,offset,false)}return offset+2};Buffer.prototype.writeInt32LE=function writeInt32LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,2147483647,-2147483648);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&255;this[offset+1]=value>>>8;this[offset+2]=value>>>16;this[offset+3]=value>>>24}else{objectWriteUInt32(this,value,offset,true)}return offset+4};Buffer.prototype.writeInt32BE=function writeInt32BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,2147483647,-2147483648);if(value<0)value=4294967295+value+1;if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&255}else{objectWriteUInt32(this,value,offset,false)}return offset+4};function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){if(!noAssert){checkIEEE754(buf,value,offset,4)}write(buf,value,offset,littleEndian,23,4);return offset+4}Buffer.prototype.writeFloatLE=function writeFloatLE(value,offset,noAssert){return writeFloat(this,value,offset,true,noAssert)};Buffer.prototype.writeFloatBE=function writeFloatBE(value,offset,noAssert){return writeFloat(this,value,offset,false,noAssert)};function writeDouble(buf,value,offset,littleEndian,noAssert){if(!noAssert){checkIEEE754(buf,value,offset,8)}write(buf,value,offset,littleEndian,52,8);return offset+8}Buffer.prototype.writeDoubleLE=function writeDoubleLE(value,offset,noAssert){return writeDouble(this,value,offset,true,noAssert)};Buffer.prototype.writeDoubleBE=function writeDoubleBE(value,offset,noAssert){return writeDouble(this,value,offset,false,noAssert)};Buffer.prototype.copy=function copy(target,targetStart,start,end){if(!start)start=0;if(!end&&end!==0)end=this.length;if(targetStart>=target.length)targetStart=target.length;if(!targetStart)targetStart=0;if(end>0&&end<start)end=start;if(end===start)return 0;if(target.length===0||this.length===0)return 0;if(targetStart<0){throw new RangeError("targetStart out of bounds")}if(start<0||start>=this.length)throw new RangeError("sourceStart out of bounds");if(end<0)throw new RangeError("sourceEnd out of bounds");if(end>this.length)end=this.length;if(target.length-targetStart<end-start){end=target.length-targetStart+start}var len=end-start;var i;if(this===target&&start<targetStart&&targetStart<end){for(i=len-1;i>=0;--i){target[i+targetStart]=this[i+start]}}else if(len<1e3||!Buffer.TYPED_ARRAY_SUPPORT){for(i=0;i<len;++i){target[i+targetStart]=this[i+start]}}else{Uint8Array.prototype.set.call(target,this.subarray(start,start+len),targetStart)}return len};Buffer.prototype.fill=function fill(val,start,end,encoding){if(typeof val==="string"){if(typeof start==="string"){encoding=start;start=0;end=this.length}else if(typeof end==="string"){encoding=end;end=this.length}if(val.length===1){var code=val.charCodeAt(0);if(code<256){val=code}}if(encoding!==undefined&&typeof encoding!=="string"){throw new TypeError("encoding must be a string")}if(typeof encoding==="string"&&!Buffer.isEncoding(encoding)){throw new TypeError("Unknown encoding: "+encoding)}}else if(typeof val==="number"){val=val&255}if(start<0||this.length<start||this.length<end){throw new RangeError("Out of range index")}if(end<=start){return this}start=start>>>0;end=end===undefined?this.length:end>>>0;if(!val)val=0;var i;if(typeof val==="number"){for(i=start;i<end;++i){this[i]=val}}else{var bytes=internalIsBuffer(val)?val:utf8ToBytes(new Buffer(val,encoding).toString());var len=bytes.length;for(i=0;i<end-start;++i){this[i+start]=bytes[i%len]}}return this};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;function base64clean(str){str=stringtrim(str).replace(INVALID_BASE64_RE,"");if(str.length<2)return"";while(str.length%4!==0){str=str+"="}return str}function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")}function toHex(n){if(n<16)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(string,units){units=units||Infinity;var codePoint;var length=string.length;var leadSurrogate=null;var bytes=[];for(var i=0;i<length;++i){codePoint=string.charCodeAt(i);if(codePoint>55295&&codePoint<57344){if(!leadSurrogate){if(codePoint>56319){if((units-=3)>-1)bytes.push(239,191,189);continue}else if(i+1===length){if((units-=3)>-1)bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){if((units-=3)>-1)bytes.push(239,191,189);leadSurrogate=codePoint;continue}codePoint=(leadSurrogate-55296<<10|codePoint-56320)+65536}else if(leadSurrogate){if((units-=3)>-1)bytes.push(239,191,189)}leadSurrogate=null;if(codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,codePoint&63|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,codePoint&63|128)}else if(codePoint<1114112){if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,codePoint&63|128)}else{throw new Error("Invalid code point")}}return bytes}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;++i){byteArray.push(str.charCodeAt(i)&255)}return byteArray}function utf16leToBytes(str,units){var c,hi,lo;var byteArray=[];for(var i=0;i<str.length;++i){if((units-=2)<0)break;c=str.charCodeAt(i);hi=c>>8;lo=c%256;byteArray.push(lo);byteArray.push(hi)}return byteArray}function base64ToBytes(str){return toByteArray(base64clean(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length;++i){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i]}return i}function isnan(val){return val!==val}function isBuffer(obj){return obj!=null&&(!!obj._isBuffer||isFastBuffer(obj)||isSlowBuffer(obj))}function isFastBuffer(obj){return!!obj.constructor&&typeof obj.constructor.isBuffer==="function"&&obj.constructor.isBuffer(obj)}function isSlowBuffer(obj){return typeof obj.readFloatLE==="function"&&typeof obj.slice==="function"&&isFastBuffer(obj.slice(0,0))}var DRO$1=function(){function DRO(opl){_classCallCheck(this,DRO);this.opl=opl;this.hardwareType=["OPL2","Dual OPL2","OPL3"]}_createClass(DRO,[{key:"load",value:function load(buffer){var header=new Buffer.from(buffer.buffer).slice(0,8).toString();if(header!="DBRAWOPL")throw new Error('Buffer is not a "DOSBox Raw OPL" file');var buffer=this.data=new DataView(buffer.buffer);this.version="v"+buffer.getUint16(8,true)+"."+buffer.getUint16(10,true);this.size=buffer.getUint32(12,true);this.length=buffer.getUint32(16,true);this.hardware=this.hardwareType[buffer.getUint8(20)];this.dataFormat=buffer.getUint8(21);this.compression=buffer.getUint8(22);this.shortDelay=buffer.getUint8(23);this.longDelay=buffer.getUint8(24);this.codemapSize=buffer.getUint8(25);this.position=26;this.codemap=[];for(var i=0;i<this.codemapSize;i++){this.codemap[i]=buffer.getUint8(this.position++)}this.start=this.position}},{key:"update",value:function update(){this.delay=0;while(!this.delay&&this.position<this.data.byteLength){var index=this.data.getUint8(this.position);var reg=this.codemap[index];if(index&128){reg=256+this.codemap[index&127]}if(this.position+1>=this.data.byteLength){return false}var value=this.data.getUint8(this.position+1);this.position+=2;if(index==this.shortDelay){this.delay=value+1;return true}else if(index==this.longDelay){this.delay=value+1<<8;return true}else if(typeof reg=="number"){this.midi_write_adlib(reg,value)}else throw Error("Unknown index: "+index)}return false}},{key:"rewind",value:function rewind(){this.position=this.start}},{key:"refresh",value:function refresh(){return this.delay/8*1/120}},{key:"midi_write_adlib",value:function midi_write_adlib(r,v){var a=0;if(r>=256){a=1;r-=256}this.opl.write(a,r,v)}}]);return DRO}();var dro=DRO$1;var extend=extend$2;function IMF$1(opl){this.opl=opl}var imf=IMF$1;extend(IMF$1.prototype,{load:function load(buffer){this.data=new DataView(buffer.buffer);this.size=this.data.getUint16(0,true);if(!this.size){this.type=0;this.position=0;this.size=this.data.byteLength}else{this.type=1;this.position=2}},update:function update(){this.delay=0;while(!this.delay&&this.position<this.size){try{var reg=this.data.getUint8(this.position++);var value=this.data.getUint8(this.position++);this.delay=this.data.getUint16(this.position,true);this.position+=2;this.midi_write_adlib(reg,value);if(this.delay)return true}catch(err){break}}return false},rewind:function rewind(){this.position=0},refresh:function refresh(){return this.delay/700},midi_write_adlib:function midi_write_adlib(r,v){var a=0;if(r>=256){a=1;r-=256}this.opl.write(a,r,v)}});var RAW$1=function(){function RAW(opl){_classCallCheck(this,RAW);this.opl=opl}_createClass(RAW,[{key:"load",value:function load(buffer){var header=new Buffer.from(buffer.buffer).slice(0,8).toString();if(header!="RAWADATA")throw new Error('Buffer is not a "Rdos Raw OPL Capture" file');this.data=new DataView(buffer.buffer);this.clock=this.data.getUint16(8,true);this.rewind()}},{key:"update",value:function update(){this.delay=0;while(!this.songend&&!this.delay&&this.position<this.data.byteLength){var value=this.data.getUint8(this.position++);var reg=this.data.getUint8(this.position++);switch(reg){case 255:if(value==255)this.songend=true;break;case 0:this.delay=value||255;break;case 2:switch(value){case 0:this.clock=this.data.getUint16(this.position,true);this.position+=2;break;case 1:this.bank=0;break;case 2:this.bank=1;break}break;default:this.midi_write_adlib(reg,value)}}return!this.songend&&this.delay}},{key:"rewind",value:function rewind(){this.songend=false;this.delay=0;this.position=10;this.bank=0;this.opl.write(1,32)}},{key:"refresh",value:function refresh(){return this.delay/(1193180/(this.clock||65535))}},{key:"midi_write_adlib",value:function midi_write_adlib(r,v){this.opl.write(this.bank,r,v)}}]);return RAW}();var raw=RAW$1;var _rad=new WeakMap;var RAD$1=function(){function RAD(opl){_classCallCheck(this,RAD);_classPrivateFieldInitSpec(this,_rad,{writable:true,value:{speed:6,speedCnt:6,order:[],orderPos:0,patterns:new Array(32),patternPos:0,currentLine:0,instruments:new Array(32),Old43:[],OldA0B0:[],ToneSlideSpeed:[],ToneSlideFreq:[],ToneSlide:[],PortSlide:[],VolSlide:[]}});_defineProperty(this,"rad_NoteFreq",[363,385,408,432,458,485,514,544,577,611,647,686]);_defineProperty(this,"rad_ChannelOffs",[32,33,34,40,41,42,48,49,50]);this.opl=opl}_createClass(RAD,[{key:"load",value:function load(buffer){var header=new Buffer.from(buffer.buffer).slice(0,16).toString();if(header!="RAD by REALiTY!!")throw new Error('Buffer is not a "RAD by REALiTY!!" file');var ptune=this.data=new DataView(buffer.buffer);var version=ptune.getUint8(16);if(version!=16)throw new Error("Unsupported RAD version: 0x"+version.toString(16));var off=17;var speed=ptune.getUint8(off);_classPrivateFieldGet(this,_rad).speed=speed&63;console.log("Speed: ",_classPrivateFieldGet(this,_rad).speed);this.rad_set_timer(speed&96?18:50);console.log("Timer: ",speed&96?18:50);if(speed&128){off++;while(ptune.getUint8(off)){off++}}off++;while(ptune.getUint8(off)){var i=ptune.getUint8(off);_classPrivateFieldGet(this,_rad).instruments[i]=Array.from(new Uint8Array(ptune.buffer.slice(off+1,off+12)));off+=12}off++;var orderSize=ptune.getUint8(off);_classPrivateFieldGet(this,_rad).order=Array.from(new Uint8Array(ptune.buffer.slice(off+1,off+1+orderSize)));console.log("Order size: ",orderSize);console.log(_classPrivateFieldGet(this,_rad).order);off+=orderSize+1;var patternList=new Uint16Array(ptune.buffer.slice(off,off+32*2));console.log(patternList);for(var p=0;p<32;p++){if(!patternList[p]){_classPrivateFieldGet(this,_rad).patterns[p]=[];continue}var o=off=patternList[p];var line;do{line=ptune.getUint8(o);o++;var ch;do{ch=ptune.getUint8(o);o++;ptune.getUint8(o);o++;var eff=ptune.getUint8(o);o++;if(eff&15)o++}while(!(ch&128))}while(!(line&128));_classPrivateFieldGet(this,_rad).patterns[p]=Array.from(new Uint8Array(ptune.buffer.slice(off,o)))}console.log(_classPrivateFieldGet(this,_rad).patterns)}},{key:"update",value:function update(){}},{key:"rewind",value:function rewind(){}},{key:"refresh",value:function refresh(){}},{key:"rad_set_timer",value:function rad_set_timer(timer){}}]);return RAD}();var rad=RAD$1;var domain;function EventHandlers(){}EventHandlers.prototype=Object.create(null);function EventEmitter(){EventEmitter.init.call(this)}EventEmitter.EventEmitter=EventEmitter;EventEmitter.usingDomains=false;EventEmitter.prototype.domain=undefined;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.init=function(){this.domain=null;if(EventEmitter.usingDomains){if(domain.active);}if(!this._events||this._events===Object.getPrototypeOf(this)._events){this._events=new EventHandlers;this._eventsCount=0}this._maxListeners=this._maxListeners||undefined};EventEmitter.prototype.setMaxListeners=function setMaxListeners(n){if(typeof n!=="number"||n<0||isNaN(n))throw new TypeError('"n" argument must be a positive number');this._maxListeners=n;return this};function $getMaxListeners(that){if(that._maxListeners===undefined)return EventEmitter.defaultMaxListeners;return that._maxListeners}EventEmitter.prototype.getMaxListeners=function getMaxListeners(){return $getMaxListeners(this)};function emitNone(handler,isFn,self){if(isFn)handler.call(self);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].call(self)}}}function emitOne(handler,isFn,self,arg1){if(isFn)handler.call(self,arg1);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].call(self,arg1)}}}function emitTwo(handler,isFn,self,arg1,arg2){if(isFn)handler.call(self,arg1,arg2);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].call(self,arg1,arg2)}}}function emitThree(handler,isFn,self,arg1,arg2,arg3){if(isFn)handler.call(self,arg1,arg2,arg3);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].call(self,arg1,arg2,arg3)}}}function emitMany(handler,isFn,self,args){if(isFn)handler.apply(self,args);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].apply(self,args)}}}EventEmitter.prototype.emit=function emit(type){var er,handler,len,args,i,events,domain;var doError=type==="error";events=this._events;if(events)doError=doError&&events.error==null;else if(!doError)return false;domain=this.domain;if(doError){er=arguments[1];if(domain){if(!er)er=new Error('Uncaught, unspecified "error" event');er.domainEmitter=this;er.domain=domain;er.domainThrown=false;domain.emit("error",er)}else if(er instanceof Error){throw er}else{var err=new Error('Uncaught, unspecified "error" event. ('+er+")");err.context=er;throw err}return false}handler=events[type];if(!handler)return false;var isFn=typeof handler==="function";len=arguments.length;switch(len){case 1:emitNone(handler,isFn,this);break;case 2:emitOne(handler,isFn,this,arguments[1]);break;case 3:emitTwo(handler,isFn,this,arguments[1],arguments[2]);break;case 4:emitThree(handler,isFn,this,arguments[1],arguments[2],arguments[3]);break;default:args=new Array(len-1);for(i=1;i<len;i++){args[i-1]=arguments[i]}emitMany(handler,isFn,this,args)}return true};function _addListener(target,type,listener,prepend){var m;var events;var existing;if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');events=target._events;if(!events){events=target._events=new EventHandlers;target._eventsCount=0}else{if(events.newListener){target.emit("newListener",type,listener.listener?listener.listener:listener);events=target._events}existing=events[type]}if(!existing){existing=events[type]=listener;++target._eventsCount}else{if(typeof existing==="function"){existing=events[type]=prepend?[listener,existing]:[existing,listener]}else{if(prepend){existing.unshift(listener)}else{existing.push(listener)}}if(!existing.warned){m=$getMaxListeners(target);if(m&&m>0&&existing.length>m){existing.warned=true;var w=new Error("Possible EventEmitter memory leak detected. "+existing.length+" "+type+" listeners added. "+"Use emitter.setMaxListeners() to increase limit");w.name="MaxListenersExceededWarning";w.emitter=target;w.type=type;w.count=existing.length;emitWarning(w)}}}return target}function emitWarning(e){typeof console.warn==="function"?console.warn(e):console.log(e)}EventEmitter.prototype.addListener=function addListener(type,listener){return _addListener(this,type,listener,false)};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.prependListener=function prependListener(type,listener){return _addListener(this,type,listener,true)};function _onceWrap(target,type,listener){var fired=false;function g(){target.removeListener(type,g);if(!fired){fired=true;listener.apply(target,arguments)}}g.listener=listener;return g}EventEmitter.prototype.once=function once(type,listener){if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');this.on(type,_onceWrap(this,type,listener));return this};EventEmitter.prototype.prependOnceListener=function prependOnceListener(type,listener){if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');this.prependListener(type,_onceWrap(this,type,listener));return this};EventEmitter.prototype.removeListener=function removeListener(type,listener){var list,events,position,i,originalListener;if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');events=this._events;if(!events)return this;list=events[type];if(!list)return this;if(list===listener||list.listener&&list.listener===listener){if(--this._eventsCount===0)this._events=new EventHandlers;else{delete events[type];if(events.removeListener)this.emit("removeListener",type,list.listener||listener)}}else if(typeof list!=="function"){position=-1;for(i=list.length;i-- >0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){originalListener=list[i].listener;position=i;break}}if(position<0)return this;if(list.length===1){list[0]=undefined;if(--this._eventsCount===0){this._events=new EventHandlers;return this}else{delete events[type]}}else{spliceOne(list,position)}if(events.removeListener)this.emit("removeListener",type,originalListener||listener)}return this};EventEmitter.prototype.removeAllListeners=function removeAllListeners(type){var listeners,events;events=this._events;if(!events)return this;if(!events.removeListener){if(arguments.length===0){this._events=new EventHandlers;this._eventsCount=0}else if(events[type]){if(--this._eventsCount===0)this._events=new EventHandlers;else delete events[type]}return this}if(arguments.length===0){var keys=Object.keys(events);for(var i=0,key;i<keys.length;++i){key=keys[i];if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events=new EventHandlers;this._eventsCount=0;return this}listeners=events[type];if(typeof listeners==="function"){this.removeListener(type,listeners)}else if(listeners){do{this.removeListener(type,listeners[listeners.length-1])}while(listeners[0])}return this};EventEmitter.prototype.listeners=function listeners(type){var evlistener;var ret;var events=this._events;if(!events)ret=[];else{evlistener=events[type];if(!evlistener)ret=[];else if(typeof evlistener==="function")ret=[evlistener.listener||evlistener];else ret=unwrapListeners(evlistener)}return ret};EventEmitter.listenerCount=function(emitter,type){if(typeof emitter.listenerCount==="function"){return emitter.listenerCount(type)}else{return listenerCount$1.call(emitter,type)}};EventEmitter.prototype.listenerCount=listenerCount$1;function listenerCount$1(type){var events=this._events;if(events){var evlistener=events[type];if(typeof evlistener==="function"){return 1}else if(evlistener){return evlistener.length}}return 0}EventEmitter.prototype.eventNames=function eventNames(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};function spliceOne(list,index){for(var i=index,k=i+1,n=list.length;k<n;i+=1,k+=1){list[i]=list[k]}list.pop()}function arrayClone(arr,i){var copy=new Array(i);while(i--){copy[i]=arr[i]}return copy}function unwrapListeners(arr){var ret=new Array(arr.length);for(var i=0;i<ret.length;++i){ret[i]=arr[i].listener||arr[i]}return ret}function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}var cachedSetTimeout=defaultSetTimout;var cachedClearTimeout=defaultClearTimeout;if(typeof global$1.setTimeout==="function"){cachedSetTimeout=setTimeout}if(typeof global$1.clearTimeout==="function"){cachedClearTimeout=clearTimeout}function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0)}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0)}try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker)}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker)}try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;runClearTimeout(timeout)}function nextTick(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue)}}function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};var title="browser";var platform="browser";var browser=true;var env={};var argv=[];var version="";var versions={};var release={};var config={};function noop(){}var on=noop;var addListener=noop;var once=noop;var off=noop;var removeListener=noop;var removeAllListeners=noop;var emit=noop;function binding(name){throw new Error("process.binding is not supported")}function cwd(){return"/"}function chdir(dir){throw new Error("process.chdir is not supported")}function umask(){return 0}var performance=global$1.performance||{};var performanceNow=performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()};function hrtime(previousTimestamp){var clocktime=performanceNow.call(performance)*.001;var seconds=Math.floor(clocktime);var nanoseconds=Math.floor(clocktime%1*1e9);if(previousTimestamp){seconds=seconds-previousTimestamp[0];nanoseconds=nanoseconds-previousTimestamp[1];if(nanoseconds<0){seconds--;nanoseconds+=1e9}}return[seconds,nanoseconds]}var startTime=new Date;function uptime(){var currentTime=new Date;var dif=currentTime-startTime;return dif/1e3}var process={nextTick:nextTick,title:title,browser:browser,env:env,argv:argv,version:version,versions:versions,on:on,addListener:addListener,once:once,off:off,removeListener:removeListener,removeAllListeners:removeAllListeners,emit:emit,binding:binding,cwd:cwd,chdir:chdir,umask:umask,hrtime:hrtime,platform:platform,release:release,config:config,uptime:uptime};var inherits;if(typeof Object.create==="function"){inherits=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{inherits=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function TempCtor(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}var inherits$1=inherits;var formatRegExp=/%[sdj%]/g;function format(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str}function deprecate(fn,msg){if(isUndefined(global$1.process)){return function(){return deprecate(fn,msg).apply(this,arguments)}}if(process.noDeprecation===true){return fn}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg)}else if(process.traceDeprecation){console.trace(msg)}else{console.error(msg)}warned=true}return fn.apply(this,arguments)}return deprecated}var debugs={};var debugEnviron;function debuglog(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||"";set=set.toUpperCase();if(!debugs[set]){if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=0;debugs[set]=function(){var msg=format.apply(null,arguments);console.error("%s %d: %s",set,pid,msg)}}else{debugs[set]=function(){}}}return debugs[set]}function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){_extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value)}if(isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0)){return formatError(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var length=output.reduce(function(prev,cur){if(cur.indexOf("\n")>=0);return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}function isBoolean(arg){return typeof arg==="boolean"}function isNull(arg){return arg===null}function isNumber(arg){return typeof arg==="number"}function isString(arg){return typeof arg==="string"}function isUndefined(arg){return arg===void 0}function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}function isObject(arg){return _typeof(arg)==="object"&&arg!==null}function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}function isError(e){return isObject(e)&&(objectToString(e)==="[object Error]"||e instanceof Error)}function isFunction(arg){return typeof arg==="function"}function objectToString(o){return Object.prototype.toString.call(o)}function _extend(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin}function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}function BufferList(){this.head=null;this.tail=null;this.length=0}BufferList.prototype.push=function(v){var entry={data:v,next:null};if(this.length>0)this.tail.next=entry;else this.head=entry;this.tail=entry;++this.length};BufferList.prototype.unshift=function(v){var entry={data:v,next:this.head};if(this.length===0)this.tail=entry;this.head=entry;++this.length};BufferList.prototype.shift=function(){if(this.length===0)return;var ret=this.head.data;if(this.length===1)this.head=this.tail=null;else this.head=this.head.next;--this.length;return ret};BufferList.prototype.clear=function(){this.head=this.tail=null;this.length=0};BufferList.prototype.join=function(s){if(this.length===0)return"";var p=this.head;var ret=""+p.data;while(p=p.next){ret+=s+p.data}return ret};BufferList.prototype.concat=function(n){if(this.length===0)return Buffer.alloc(0);if(this.length===1)return this.head.data;var ret=Buffer.allocUnsafe(n>>>0);var p=this.head;var i=0;while(p){p.data.copy(ret,i);i+=p.data.length;p=p.next}return ret};var isBufferEncoding=Buffer.isEncoding||function(encoding){switch(encoding&&encoding.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return true;default:return false}};function assertEncoding(encoding){if(encoding&&!isBufferEncoding(encoding)){throw new Error("Unknown encoding: "+encoding)}}function StringDecoder(encoding){this.encoding=(encoding||"utf8").toLowerCase().replace(/[-_]/,"");assertEncoding(encoding);switch(this.encoding){case"utf8":this.surrogateSize=3;break;case"ucs2":case"utf16le":this.surrogateSize=2;this.detectIncompleteChar=utf16DetectIncompleteChar;break;case"base64":this.surrogateSize=3;this.detectIncompleteChar=base64DetectIncompleteChar;break;default:this.write=passThroughWrite;return}this.charBuffer=new Buffer(6);this.charReceived=0;this.charLength=0}StringDecoder.prototype.write=function(buffer){var charStr="";while(this.charLength){var available=buffer.length>=this.charLength-this.charReceived?this.charLength-this.charReceived:buffer.length;buffer.copy(this.charBuffer,this.charReceived,0,available);this.charReceived+=available;if(this.charReceived<this.charLength){return""}buffer=buffer.slice(available,buffer.length);charStr=this.charBuffer.slice(0,this.charLength).toString(this.encoding);var charCode=charStr.charCodeAt(charStr.length-1);if(charCode>=55296&&charCode<=56319){this.charLength+=this.surrogateSize;charStr="";continue}this.charReceived=this.charLength=0;if(buffer.length===0){return charStr}break}this.detectIncompleteChar(buffer);var end=buffer.length;if(this.charLength){buffer.copy(this.charBuffer,0,buffer.length-this.charReceived,end);end-=this.charReceived}charStr+=buffer.toString(this.encoding,0,end);var end=charStr.length-1;var charCode=charStr.charCodeAt(end);if(charCode>=55296&&charCode<=56319){var size=this.surrogateSize;this.charLength+=size;this.charReceived+=size;this.charBuffer.copy(this.charBuffer,size,0,size);buffer.copy(this.charBuffer,0,0,size);return charStr.substring(0,end)}return charStr};StringDecoder.prototype.detectIncompleteChar=function(buffer){var i=buffer.length>=3?3:buffer.length;for(;i>0;i--){var c=buffer[buffer.length-i];if(i==1&&c>>5==6){this.charLength=2;break}if(i<=2&&c>>4==14){this.charLength=3;break}if(i<=3&&c>>3==30){this.charLength=4;break}}this.charReceived=i};StringDecoder.prototype.end=function(buffer){var res="";if(buffer&&buffer.length)res=this.write(buffer);if(this.charReceived){var cr=this.charReceived;var buf=this.charBuffer;var enc=this.encoding;res+=buf.slice(0,cr).toString(enc)}return res};function passThroughWrite(buffer){return buffer.toString(this.encoding)}function utf16DetectIncompleteChar(buffer){this.charReceived=buffer.length%2;this.charLength=this.charReceived?2:0}function base64DetectIncompleteChar(buffer){this.charReceived=buffer.length%3;this.charLength=this.charReceived?3:0}Readable.ReadableState=ReadableState;var debug=debuglog("stream");inherits$1(Readable,EventEmitter);function prependListener(emitter,event,fn){if(typeof emitter.prependListener==="function"){return emitter.prependListener(event,fn)}else{if(!emitter._events||!emitter._events[event])emitter.on(event,fn);else if(Array.isArray(emitter._events[event]))emitter._events[event].unshift(fn);else emitter._events[event]=[fn,emitter._events[event]]}}function listenerCount(emitter,type){return emitter.listeners(type).length}function ReadableState(options,stream){options=options||{};this.objectMode=!!options.objectMode;if(stream instanceof Duplex)this.objectMode=this.objectMode||!!options.readableObjectMode;var hwm=options.highWaterMark;var defaultHwm=this.objectMode?16:16*1024;this.highWaterMark=hwm||hwm===0?hwm:defaultHwm;this.highWaterMark=~~this.highWaterMark;this.buffer=new BufferList;this.length=0;this.pipes=null;this.pipesCount=0;this.flowing=null;this.ended=false;this.endEmitted=false;this.reading=false;this.sync=true;this.needReadable=false;this.emittedReadable=false;this.readableListening=false;this.resumeScheduled=false;this.defaultEncoding=options.defaultEncoding||"utf8";this.ranOut=false;this.awaitDrain=0;this.readingMore=false;this.decoder=null;this.encoding=null;if(options.encoding){this.decoder=new StringDecoder(options.encoding);this.encoding=options.encoding}}function Readable(options){if(!(this instanceof Readable))return new Readable(options);this._readableState=new ReadableState(options,this);this.readable=true;if(options&&typeof options.read==="function")this._read=options.read;EventEmitter.call(this)}Readable.prototype.push=function(chunk,encoding){var state=this._readableState;if(!state.objectMode&&typeof chunk==="string"){encoding=encoding||state.defaultEncoding;if(encoding!==state.encoding){chunk=Buffer.from(chunk,encoding);encoding=""}}return readableAddChunk(this,state,chunk,encoding,false)};Readable.prototype.unshift=function(chunk){var state=this._readableState;return readableAddChunk(this,state,chunk,"",true)};Readable.prototype.isPaused=function(){return this._readableState.flowing===false};function readableAddChunk(stream,state,chunk,encoding,addToFront){var er=chunkInvalid(state,chunk);if(er){stream.emit("error",er)}else if(chunk===null){state.reading=false;onEofChunk(stream,state)}else if(state.objectMode||chunk&&chunk.length>0){if(state.ended&&!addToFront){var e=new Error("stream.push() after EOF");stream.emit("error",e)}else if(state.endEmitted&&addToFront){var _e=new Error("stream.unshift() after end event");stream.emit("error",_e)}else{var skipAdd;if(state.decoder&&!addToFront&&!encoding){chunk=state.decoder.write(chunk);skipAdd=!state.objectMode&&chunk.length===0}if(!addToFront)state.reading=false;if(!skipAdd){if(state.flowing&&state.length===0&&!state.sync){stream.emit("data",chunk);stream.read(0)}else{state.length+=state.objectMode?1:chunk.length;if(addToFront)state.buffer.unshift(chunk);else state.buffer.push(chunk);if(state.needReadable)emitReadable(stream)}}maybeReadMore(stream,state)}}else if(!addToFront){state.reading=false}return needMoreData(state)}function needMoreData(state){return!state.ended&&(state.needReadable||state.length<state.highWaterMark||state.length===0)}Readable.prototype.setEncoding=function(enc){this._readableState.decoder=new StringDecoder(enc);this._readableState.encoding=enc;return this};var MAX_HWM=8388608;function computeNewHighWaterMark(n){if(n>=MAX_HWM){n=MAX_HWM}else{n--;n|=n>>>1;n|=n>>>2;n|=n>>>4;n|=n>>>8;n|=n>>>16;n++}return n}function howMuchToRead(n,state){if(n<=0||state.length===0&&state.ended)return 0;if(state.objectMode)return 1;if(n!==n){if(state.flowing&&state.length)return state.buffer.head.data.length;else return state.length}if(n>state.highWaterMark)state.highWaterMark=computeNewHighWaterMark(n);if(n<=state.length)return n;if(!state.ended){state.needReadable=true;return 0}return state.length}Readable.prototype.read=function(n){debug("read",n);n=parseInt(n,10);var state=this._readableState;var nOrig=n;if(n!==0)state.emittedReadable=false;if(n===0&&state.needReadable&&(state.length>=state.highWaterMark||state.ended)){debug("read: emitReadable",state.length,state.ended);if(state.length===0&&state.ended)endReadable(this);else emitReadable(this);return null}n=howMuchToRead(n,state);if(n===0&&state.ended){if(state.length===0)endReadable(this);return null}var doRead=state.needReadable;debug("need readable",doRead);if(state.length===0||state.length-n<state.highWaterMark){doRead=true;debug("length less than watermark",doRead)}if(state.ended||state.reading){doRead=false;debug("reading or ended",doRead)}else if(doRead){debug("do read");state.reading=true;state.sync=true;if(state.length===0)state.needReadable=true;this._read(state.highWaterMark);state.sync=false;if(!state.reading)n=howMuchToRead(nOrig,state)}var ret;if(n>0)ret=fromList(n,state);else ret=null;if(ret===null){state.needReadable=true;n=0}else{state.length-=n}if(state.length===0){if(!state.ended)state.needReadable=true;if(nOrig!==n&&state.ended)endReadable(this)}if(ret!==null)this.emit("data",ret);return ret};function chunkInvalid(state,chunk){var er=null;if(!isBuffer(chunk)&&typeof chunk!=="string"&&chunk!==null&&chunk!==undefined&&!state.objectMode){er=new TypeError("Invalid non-string/buffer chunk")}return er}function onEofChunk(stream,state){if(state.ended)return;if(state.decoder){var chunk=state.decoder.end();if(chunk&&chunk.length){state.buffer.push(chunk);state.length+=state.objectMode?1:chunk.length}}state.ended=true;emitReadable(stream)}function emitReadable(stream){var state=stream._readableState;state.needReadable=false;if(!state.emittedReadable){debug("emitReadable",state.flowing);state.emittedReadable=true;if(state.sync)nextTick(emitReadable_,stream);else emitReadable_(stream)}}function emitReadable_(stream){debug("emit readable");stream.emit("readable");flow(stream)}function maybeReadMore(stream,state){if(!state.readingMore){state.readingMore=true;nextTick(maybeReadMore_,stream,state)}}function maybeReadMore_(stream,state){var len=state.length;while(!state.reading&&!state.flowing&&!state.ended&&state.length<state.highWaterMark){debug("maybeReadMore read 0");stream.read(0);if(len===state.length)break;else len=state.length}state.readingMore=false}Readable.prototype._read=function(n){this.emit("error",new Error("not implemented"))};Readable.prototype.pipe=function(dest,pipeOpts){var src=this;var state=this._readableState;switch(state.pipesCount){case 0:state.pipes=dest;break;case 1:state.pipes=[state.pipes,dest];break;default:state.pipes.push(dest);break}state.pipesCount+=1;debug("pipe count=%d opts=%j",state.pipesCount,pipeOpts);var doEnd=!pipeOpts||pipeOpts.end!==false;var endFn=doEnd?onend:cleanup;if(state.endEmitted)nextTick(endFn);else src.once("end",endFn);dest.on("unpipe",onunpipe);function onunpipe(readable){debug("onunpipe");if(readable===src){cleanup()}}function onend(){debug("onend");dest.end()}var ondrain=pipeOnDrain(src);dest.on("drain",ondrain);var cleanedUp=false;function cleanup(){debug("cleanup");dest.removeListener("close",onclose);dest.removeListener("finish",onfinish);dest.removeListener("drain",ondrain);dest.removeListener("error",onerror);dest.removeListener("unpipe",onunpipe);src.removeListener("end",onend);src.removeListener("end",cleanup);src.removeListener("data",ondata);cleanedUp=true;if(state.awaitDrain&&(!dest._writableState||dest._writableState.needDrain))ondrain()}var increasedAwaitDrain=false;src.on("data",ondata);function ondata(chunk){debug("ondata");increasedAwaitDrain=false;var ret=dest.write(chunk);if(false===ret&&!increasedAwaitDrain){if((state.pipesCount===1&&state.pipes===dest||state.pipesCount>1&&indexOf(state.pipes,dest)!==-1)&&!cleanedUp){debug("false write response, pause",src._readableState.awaitDrain);src._readableState.awaitDrain++;increasedAwaitDrain=true}src.pause()}}function onerror(er){debug("onerror",er);unpipe();dest.removeListener("error",onerror);if(listenerCount(dest,"error")===0)dest.emit("error",er)}prependListener(dest,"error",onerror);function onclose(){dest.removeListener("finish",onfinish);unpipe()}dest.once("close",onclose);function onfinish(){debug("onfinish");dest.removeListener("close",onclose);unpipe()}dest.once("finish",onfinish);function unpipe(){debug("unpipe");src.unpipe(dest)}dest.emit("pipe",src);if(!state.flowing){debug("pipe resume");src.resume()}return dest};function pipeOnDrain(src){return function(){var state=src._readableState;debug("pipeOnDrain",state.awaitDrain);if(state.awaitDrain)state.awaitDrain--;if(state.awaitDrain===0&&src.listeners("data").length){state.flowing=true;flow(src)}}}Readable.prototype.unpipe=function(dest){var state=this._readableState;if(state.pipesCount===0)return this;if(state.pipesCount===1){if(dest&&dest!==state.pipes)return this;if(!dest)dest=state.pipes;state.pipes=null;state.pipesCount=0;state.flowing=false;if(dest)dest.emit("unpipe",this);return this}if(!dest){var dests=state.pipes;var len=state.pipesCount;state.pipes=null;state.pipesCount=0;state.flowing=false;for(var _i=0;_i<len;_i++){dests[_i].emit("unpipe",this)}return this}var i=indexOf(state.pipes,dest);if(i===-1)return this;state.pipes.splice(i,1);state.pipesCount-=1;if(state.pipesCount===1)state.pipes=state.pipes[0];dest.emit("unpipe",this);return this};Readable.prototype.on=function(ev,fn){var res=EventEmitter.prototype.on.call(this,ev,fn);if(ev==="data"){if(this._readableState.flowing!==false)this.resume()}else if(ev==="readable"){var state=this._readableState;if(!state.endEmitted&&!state.readableListening){state.readableListening=state.needReadable=true;state.emittedReadable=false;if(!state.reading){nextTick(nReadingNextTick,this)}else if(state.length){emitReadable(this)}}}return res};Readable.prototype.addListener=Readable.prototype.on;function nReadingNextTick(self){debug("readable nexttick read 0");self.read(0)}Readable.prototype.resume=function(){var state=this._readableState;if(!state.flowing){debug("resume");state.flowing=true;resume(this,state)}return this};function resume(stream,state){if(!state.resumeScheduled){state.resumeScheduled=true;nextTick(resume_,stream,state)}}function resume_(stream,state){if(!state.reading){debug("resume read 0");stream.read(0)}state.resumeScheduled=false;state.awaitDrain=0;stream.emit("resume");flow(stream);if(state.flowing&&!state.reading)stream.read(0)}Readable.prototype.pause=function(){debug("call pause flowing=%j",this._readableState.flowing);if(false!==this._readableState.flowing){debug("pause");this._readableState.flowing=false;this.emit("pause")}return this};function flow(stream){var state=stream._readableState;debug("flow",state.flowing);while(state.flowing&&stream.read()!==null){}}Readable.prototype.wrap=function(stream){var state=this._readableState;var paused=false;var self=this;stream.on("end",function(){debug("wrapped end");if(state.decoder&&!state.ended){var chunk=state.decoder.end();if(chunk&&chunk.length)self.push(chunk)}self.push(null)});stream.on("data",function(chunk){debug("wrapped data");if(state.decoder)chunk=state.decoder.write(chunk);if(state.objectMode&&(chunk===null||chunk===undefined))return;else if(!state.objectMode&&(!chunk||!chunk.length))return;var ret=self.push(chunk);if(!ret){paused=true;stream.pause()}});for(var i in stream){if(this[i]===undefined&&typeof stream[i]==="function"){this[i]=function(method){return function(){return stream[method].apply(stream,arguments)}}(i)}}var events=["error","close","destroy","pause","resume"];forEach(events,function(ev){stream.on(ev,self.emit.bind(self,ev))});self._read=function(n){debug("wrapped _read",n);if(paused){paused=false;stream.resume()}};return self};Readable._fromList=fromList;function fromList(n,state){if(state.length===0)return null;var ret;if(state.objectMode)ret=state.buffer.shift();else if(!n||n>=state.length){if(state.decoder)ret=state.buffer.join("");else if(state.buffer.length===1)ret=state.buffer.head.data;else ret=state.buffer.concat(state.length);state.buffer.clear()}else{ret=fromListPartial(n,state.buffer,state.decoder)}return ret}function fromListPartial(n,list,hasStrings){var ret;if(n<list.head.data.length){ret=list.head.data.slice(0,n);list.head.data=list.head.data.slice(n)}else if(n===list.head.data.length){ret=list.shift()}else{ret=hasStrings?copyFromBufferString(n,list):copyFromBuffer(n,list)}return ret}function copyFromBufferString(n,list){var p=list.head;var c=1;var ret=p.data;n-=ret.length;while(p=p.next){var str=p.data;var nb=n>str.length?str.length:n;if(nb===str.length)ret+=str;else ret+=str.slice(0,n);n-=nb;if(n===0){if(nb===str.length){++c;if(p.next)list.head=p.next;else list.head=list.tail=null}else{list.head=p;p.data=str.slice(nb)}break}++c}list.length-=c;return ret}function copyFromBuffer(n,list){var ret=Buffer.allocUnsafe(n);var p=list.head;var c=1;p.data.copy(ret);n-=p.data.length;while(p=p.next){var buf=p.data;var nb=n>buf.length?buf.length:n;buf.copy(ret,ret.length-n,0,nb);n-=nb;if(n===0){if(nb===buf.length){++c;if(p.next)list.head=p.next;else list.head=list.tail=null}else{list.head=p;p.data=buf.slice(nb)}break}++c}list.length-=c;return ret}function endReadable(stream){var state=stream._readableState;if(state.length>0)throw new Error('"endReadable()" called on non-empty stream');if(!state.endEmitted){state.ended=true;nextTick(endReadableNT,state,stream)}}function endReadableNT(state,stream){if(!state.endEmitted&&state.length===0){state.endEmitted=true;stream.readable=false;stream.emit("end")}}function forEach(xs,f){for(var i=0,l=xs.length;i<l;i++){f(xs[i],i)}}function indexOf(xs,x){for(var i=0,l=xs.length;i<l;i++){if(xs[i]===x)return i}return-1}Writable.WritableState=WritableState;inherits$1(Writable,EventEmitter);function nop(){}function WriteReq(chunk,encoding,cb){this.chunk=chunk;this.encoding=encoding;this.callback=cb;this.next=null}function WritableState(options,stream){Object.defineProperty(this,"buffer",{get:deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer "+"instead.")});options=options||{};this.objectMode=!!options.objectMode;if(stream instanceof Duplex)this.objectMode=this.objectMode||!!options.writableObjectMode;var hwm=options.highWaterMark;var defaultHwm=this.objectMode?16:16*1024;this.highWaterMark=hwm||hwm===0?hwm:defaultHwm;this.highWaterMark=~~this.highWaterMark;this.needDrain=false;this.ending=false;this.ended=false;this.finished=false;var noDecode=options.decodeStrings===false;this.decodeStrings=!noDecode;this.defaultEncoding=options.defaultEncoding||"utf8";this.length=0;this.writing=false;this.corked=0;this.sync=true;this.bufferProcessing=false;this.onwrite=function(er){onwrite(stream,er)};this.writecb=null;this.writelen=0;this.bufferedRequest=null;this.lastBufferedRequest=null;this.pendingcb=0;this.prefinished=false;this.errorEmitted=false;this.bufferedRequestCount=0;this.corkedRequestsFree=new CorkedRequest(this)}WritableState.prototype.getBuffer=function writableStateGetBuffer(){var current=this.bufferedRequest;var out=[];while(current){out.push(current);current=current.next}return out};function Writable(options){if(!(this instanceof Writable)&&!(this instanceof Duplex))return new Writable(options);this._writableState=new WritableState(options,this);this.writable=true;if(options){if(typeof options.write==="function")this._write=options.write;if(typeof options.writev==="function")this._writev=options.writev}EventEmitter.call(this)}Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))};function writeAfterEnd(stream,cb){var er=new Error("write after end");stream.emit("error",er);nextTick(cb,er)}function validChunk(stream,state,chunk,cb){var valid=true;var er=false;if(chunk===null){er=new TypeError("May not write null values to stream")}else if(!Buffer.isBuffer(chunk)&&typeof chunk!=="string"&&chunk!==undefined&&!state.objectMode){er=new TypeError("Invalid non-string/buffer chunk")}if(er){stream.emit("error",er);nextTick(cb,er);valid=false}return valid}Writable.prototype.write=function(chunk,encoding,cb){var state=this._writableState;var ret=false;if(typeof encoding==="function"){cb=encoding;encoding=null}if(Buffer.isBuffer(chunk))encoding="buffer";else if(!encoding)encoding=state.defaultEncoding;if(typeof cb!=="function")cb=nop;if(state.ended)writeAfterEnd(this,cb);else if(validChunk(this,state,chunk,cb)){state.pendingcb++;ret=writeOrBuffer(this,state,chunk,encoding,cb)}return ret};Writable.prototype.cork=function(){var state=this._writableState;state.corked++};Writable.prototype.uncork=function(){var state=this._writableState;if(state.corked){state.corked--;if(!state.writing&&!state.corked&&!state.finished&&!state.bufferProcessing&&state.bufferedRequest)clearBuffer(this,state)}};Writable.prototype.setDefaultEncoding=function setDefaultEncoding(encoding){if(typeof encoding==="string")encoding=encoding.toLowerCase();if(!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((encoding+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+encoding);this._writableState.defaultEncoding=encoding;return this};function decodeChunk(state,chunk,encoding){if(!state.objectMode&&state.decodeStrings!==false&&typeof chunk==="string"){chunk=Buffer.from(chunk,encoding)}return chunk}function writeOrBuffer(stream,state,chunk,encoding,cb){chunk=decodeChunk(state,chunk,encoding);if(Buffer.isBuffer(chunk))encoding="buffer";var len=state.objectMode?1:chunk.length;state.length+=len;var ret=state.length<state.highWaterMark;if(!ret)state.needDrain=true;if(state.writing||state.corked){var last=state.lastBufferedRequest;state.lastBufferedRequest=new WriteReq(chunk,encoding,cb);if(last){last.next=state.lastBufferedRequest}else{state.bufferedRequest=state.lastBufferedRequest}state.bufferedRequestCount+=1}else{doWrite(stream,state,false,len,chunk,encoding,cb)}return ret}function doWrite(stream,state,writev,len,chunk,encoding,cb){state.writelen=len;state.writecb=cb;state.writing=true;state.sync=true;if(writev)stream._writev(chunk,state.onwrite);else stream._write(chunk,encoding,state.onwrite);state.sync=false}function onwriteError(stream,state,sync,er,cb){--state.pendingcb;if(sync)nextTick(cb,er);else cb(er);stream._writableState.errorEmitted=true;stream.emit("error",er)}function onwriteStateUpdate(state){state.writing=false;state.writecb=null;state.length-=state.writelen;state.writelen=0}function onwrite(stream,er){var state=stream._writableState;var sync=state.sync;var cb=state.writecb;onwriteStateUpdate(state);if(er)onwriteError(stream,state,sync,er,cb);else{var finished=needFinish(state);if(!finished&&!state.corked&&!state.bufferProcessing&&state.bufferedRequest){clearBuffer(stream,state)}if(sync){nextTick(afterWrite,stream,state,finished,cb)}else{afterWrite(stream,state,finished,cb)}}}function afterWrite(stream,state,finished,cb){if(!finished)onwriteDrain(stream,state);state.pendingcb--;cb();finishMaybe(stream,state)}function onwriteDrain(stream,state){if(state.length===0&&state.needDrain){state.needDrain=false;stream.emit("drain")}}function clearBuffer(stream,state){state.bufferProcessing=true;var entry=state.bufferedRequest;if(stream._writev&&entry&&entry.next){var l=state.bufferedRequestCount;var buffer=new Array(l);var holder=state.corkedRequestsFree;holder.entry=entry;var count=0;while(entry){buffer[count]=entry;entry=entry.next;count+=1}doWrite(stream,state,true,state.length,buffer,"",holder.finish);state.pendingcb++;state.lastBufferedRequest=null;if(holder.next){state.corkedRequestsFree=holder.next;holder.next=null}else{state.corkedRequestsFree=new CorkedRequest(state)}}else{while(entry){var chunk=entry.chunk;var encoding=entry.encoding;var cb=entry.callback;var len=state.objectMode?1:chunk.length;doWrite(stream,state,false,len,chunk,encoding,cb);entry=entry.next;if(state.writing){break}}if(entry===null)state.lastBufferedRequest=null}state.bufferedRequestCount=0;state.bufferedRequest=entry;state.bufferProcessing=false}Writable.prototype._write=function(chunk,encoding,cb){cb(new Error("not implemented"))};Writable.prototype._writev=null;Writable.prototype.end=function(chunk,encoding,cb){var state=this._writableState;if(typeof chunk==="function"){cb=chunk;chunk=null;encoding=null}else if(typeof encoding==="function"){cb=encoding;encoding=null}if(chunk!==null&&chunk!==undefined)this.write(chunk,encoding);if(state.corked){state.corked=1;this.uncork()}if(!state.ending&&!state.finished)endWritable(this,state,cb)};function needFinish(state){return state.ending&&state.length===0&&state.bufferedRequest===null&&!state.finished&&!state.writing}function prefinish(stream,state){if(!state.prefinished){state.prefinished=true;stream.emit("prefinish")}}function finishMaybe(stream,state){var need=needFinish(state);if(need){if(state.pendingcb===0){prefinish(stream,state);state.finished=true;stream.emit("finish")}else{prefinish(stream,state)}}return need}function endWritable(stream,state,cb){state.ending=true;finishMaybe(stream,state);if(cb){if(state.finished)nextTick(cb);else stream.once("finish",cb)}state.ended=true;stream.writable=false}function CorkedRequest(state){var _this=this;this.next=null;this.entry=null;this.finish=function(err){var entry=_this.entry;_this.entry=null;while(entry){var cb=entry.callback;state.pendingcb--;cb(err);entry=entry.next}if(state.corkedRequestsFree){state.corkedRequestsFree.next=_this}else{state.corkedRequestsFree=_this}}}inherits$1(Duplex,Readable);var keys=Object.keys(Writable.prototype);for(var v=0;v<keys.length;v++){var method=keys[v];if(!Duplex.prototype[method])Duplex.prototype[method]=Writable.prototype[method]}function Duplex(options){if(!(this instanceof Duplex))return new Duplex(options);Readable.call(this,options);Writable.call(this,options);if(options&&options.readable===false)this.readable=false;if(options&&options.writable===false)this.writable=false;this.allowHalfOpen=true;if(options&&options.allowHalfOpen===false)this.allowHalfOpen=false;this.once("end",onend)}function onend(){if(this.allowHalfOpen||this._writableState.ended)return;nextTick(onEndNT,this)}function onEndNT(self){self.end()}inherits$1(Transform,Duplex);function TransformState(stream){this.afterTransform=function(er,data){return afterTransform(stream,er,data)};this.needTransform=false;this.transforming=false;this.writecb=null;this.writechunk=null;this.writeencoding=null}function afterTransform(stream,er,data){var ts=stream._transformState;ts.transforming=false;var cb=ts.writecb;if(!cb)return stream.emit("error",new Error("no writecb in Transform class"));ts.writechunk=null;ts.writecb=null;if(data!==null&&data!==undefined)stream.push(data);cb(er);var rs=stream._readableState;rs.reading=false;if(rs.needReadable||rs.length<rs.highWaterMark){stream._read(rs.highWaterMark)}}function Transform(options){if(!(this instanceof Transform))return new Transform(options);Duplex.call(this,options);this._transformState=new TransformState(this);var stream=this;this._readableState.needReadable=true;this._readableState.sync=false;if(options){if(typeof options.transform==="function")this._transform=options.transform;if(typeof options.flush==="function")this._flush=options.flush}this.once("prefinish",function(){if(typeof this._flush==="function")this._flush(function(er){done(stream,er)});else done(stream)})}Transform.prototype.push=function(chunk,encoding){this._transformState.needTransform=false;return Duplex.prototype.push.call(this,chunk,encoding)};Transform.prototype._transform=function(chunk,encoding,cb){throw new Error("Not implemented")};Transform.prototype._write=function(chunk,encoding,cb){var ts=this._transformState;ts.writecb=cb;ts.writechunk=chunk;ts.writeencoding=encoding;if(!ts.transforming){var rs=this._readableState;if(ts.needTransform||rs.needReadable||rs.length<rs.highWaterMark)this._read(rs.highWaterMark)}};Transform.prototype._read=function(n){var ts=this._transformState;if(ts.writechunk!==null&&ts.writecb&&!ts.transforming){ts.transforming=true;this._transform(ts.writechunk,ts.writeencoding,ts.afterTransform)}else{ts.needTransform=true}};function done(stream,er){if(er)return stream.emit("error",er);var ws=stream._writableState;var ts=stream._transformState;if(ws.length)throw new Error("Calling transform done when ws.length != 0");if(ts.transforming)throw new Error("Calling transform done when still transforming");return stream.push(null)}inherits$1(PassThrough,Transform);function PassThrough(options){if(!(this instanceof PassThrough))return new PassThrough(options);Transform.call(this,options)}PassThrough.prototype._transform=function(chunk,encoding,cb){cb(null,chunk)};inherits$1(Stream,EventEmitter);Stream.Readable=Readable;Stream.Writable=Writable;Stream.Duplex=Duplex;Stream.Transform=Transform;Stream.PassThrough=PassThrough;Stream.Stream=Stream;function Stream(){EventEmitter.call(this)}Stream.prototype.pipe=function(dest,options){var source=this;function ondata(chunk){if(dest.writable){if(false===dest.write(chunk)&&source.pause){source.pause()}}}source.on("data",ondata);function ondrain(){if(source.readable&&source.resume){source.resume()}}dest.on("drain",ondrain);if(!dest._isStdio&&(!options||options.end!==false)){source.on("end",onend);source.on("close",onclose)}var didOnEnd=false;function onend(){if(didOnEnd)return;didOnEnd=true;dest.end()}function onclose(){if(didOnEnd)return;didOnEnd=true;if(typeof dest.destroy==="function")dest.destroy()}function onerror(er){cleanup();if(EventEmitter.listenerCount(this,"error")===0){throw er}}source.on("error",onerror);dest.on("error",onerror);function cleanup(){source.removeListener("data",ondata);dest.removeListener("drain",ondrain);source.removeListener("end",onend);source.removeListener("close",onclose);source.removeListener("error",onerror);dest.removeListener("error",onerror);source.removeListener("end",cleanup);source.removeListener("close",cleanup);dest.removeListener("close",cleanup)}source.on("end",cleanup);source.on("close",cleanup);dest.on("close",cleanup);dest.emit("pipe",source);return dest};var currentScriptSrc=null;try{currentScriptSrc=document.currentScript.src}catch(err){}var _options$1=new WeakMap;var MainPlayer=function(_Readable){_inherits(MainPlayer,_Readable);var _super=_createSuper(MainPlayer);function MainPlayer(format,options){var _this;_classCallCheck(this,MainPlayer);_this=_super.call(this);_classPrivateFieldInitSpec(_assertThisInitialized(_this),_options$1,{writable:true,value:{}});_defineProperty(_assertThisInitialized(_this),"opl3module",null);_defineProperty(_assertThisInitialized(_this),"audioContext",null);_defineProperty(_assertThisInitialized(_this),"worklet",null);_classPrivateFieldSet(_assertThisInitialized(_this),_options$1,options||{});_this.init();return _this}_createClass(MainPlayer,[{key:"init",value:function(){var _init=_asyncToGenerator(_regeneratorRuntime().mark(function _callee2(){var _this2=this;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return fetch(currentScriptSrc).then(function(script){return script.text()}).then(function(){var _ref=_asyncToGenerator(_regeneratorRuntime().mark(function _callee(text){return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_this2.opl3module=text;case 1:case"end":return _context.stop()}}},_callee)}));return function(_x){return _ref.apply(this,arguments)}}());case 2:case"end":return _context2.stop()}}},_callee2)}));function init(){return _init.apply(this,arguments)}return init}()},{key:"initContext",value:function(){var _initContext=_asyncToGenerator(_regeneratorRuntime().mark(function _callee3(){var gainNode;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:this.audioContext=new AudioContext;_context3.next=3;return this.audioContext.audioWorklet.addModule("test-processor.js");case 3:this.worklet=new AudioWorkletNode(this.audioContext,"test-generator",{numberOfOutputs:1,outputChannelCount:[2]});gainNode=this.audioContext.createGain();gainNode.gain.value=4;gainNode.connect(this.audioContext.destination);this.worklet.port.postMessage({cmd:"OPL3",value:this.opl3module});this.worklet.connect(gainNode);case 9:case"end":return _context3.stop()}}},_callee3,this)}));function initContext(){return _initContext.apply(this,arguments)}return initContext}()},{key:"play",value:function play(buffer){}},{key:"load",value:function(){var _load=_asyncToGenerator(_regeneratorRuntime().mark(function _callee4(buffer){return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(!(!this.audioContext||!this.worklet)){_context4.next=3;break}_context4.next=3;return this.initContext();case 3:this.worklet&&this.worklet.port.postMessage({cmd:"load",value:buffer});case 4:case"end":return _context4.stop()}}},_callee4,this)}));function load(_x2){return _load.apply(this,arguments)}return load}()}]);return MainPlayer}(Readable);var mainPlayer=Object.freeze({__proto__:null,default:MainPlayer});var require$$6=getAugmentedNamespace(mainPlayer);var OPL3=opl3$1;var DRO=dro;var IMF=imf;var LAA=laa;var RAW=raw;var RAD=rad;var _options=new WeakMap;var _format=new WeakMap;var _samplesBuffer=new WeakMap;var _sampleRate=new WeakMap;var _chunkSize=new WeakMap;var _postMessage=new WeakMap;var WorkletPlayer=function(){function WorkletPlayer(postMessage,options){_classCallCheck(this,WorkletPlayer);_classPrivateFieldInitSpec(this,_options,{writable:true,value:{}});_classPrivateFieldInitSpec(this,_format,{writable:true,value:null});_defineProperty(this,"format_player",null);_classPrivateFieldInitSpec(this,_samplesBuffer,{writable:true,value:null});_classPrivateFieldInitSpec(this,_sampleRate,{writable:true,value:null});_classPrivateFieldInitSpec(this,_chunkSize,{writable:true,value:0});_classPrivateFieldInitSpec(this,_postMessage,{writable:true,value:null});_classPrivateFieldSet(this,_postMessage,postMessage);_classPrivateFieldSet(this,_options,options||{});_classPrivateFieldGet(this,_options).bufferSize=128}_createClass(WorkletPlayer,[{key:"detectFormat",value:function detectFormat(buffer){var header=function header(offset,length){return String.fromCharCode.apply(null,new Uint8Array(buffer.slice(offset,length)))};if(header(0,3)=="ADL")return LAA;if(header(0,8)=="RAWADATA")return RAW;if(header(0,8)=="DBRAWOPL")return DRO;if(header(0,16)=="RAD by REALiTY!!")return RAD;return IMF}},{key:"play",value:function play(){}},{key:"pause",value:function pause(){}},{key:"load",value:function load(buffer){if(buffer instanceof ArrayBuffer)buffer=new Buffer.from(buffer);_classPrivateFieldSet(this,_format,_classPrivateFieldGet(this,_format)||this.detectFormat(buffer));if(!_classPrivateFieldGet(this,_format))throw"File format not detected";this.format_player=new(_classPrivateFieldGet(this,_format))(new OPL3,_classPrivateFieldGet(this,_options));this.format_player.load(buffer);_classPrivateFieldSet(this,_samplesBuffer,new Float32Array(_classPrivateFieldGet(this,_options).bufferSize*2));_classPrivateFieldSet(this,_sampleRate,49700*((_classPrivateFieldGet(this,_options).sampleRate||49700)/49700));_classPrivateFieldSet(this,_chunkSize,0);console.log("worklet_load called",this.format_player)}},{key:"update",value:function update(outputs){if(!this.format_player||!outputs)return;var seek=0;_classPrivateFieldGet(this,_samplesBuffer).fill(0);if(_classPrivateFieldGet(this,_chunkSize)===0){this.format_player.update();_classPrivateFieldSet(this,_chunkSize,2*(_classPrivateFieldGet(this,_sampleRate)*this.format_player.refresh()|0))}if(_classPrivateFieldGet(this,_chunkSize)<_classPrivateFieldGet(this,_options).bufferSize*2){this.format_player.opl.read(_classPrivateFieldGet(this,_samplesBuffer),seek,_classPrivateFieldGet(this,_chunkSize));seek+=_classPrivateFieldGet(this,_chunkSize);this.format_player.update();_classPrivateFieldSet(this,_chunkSize,2*(_classPrivateFieldGet(this,_sampleRate)*this.format_player.refresh()|0))}if(_classPrivateFieldGet(this,_chunkSize)>0){var samplesSize=Math.min(_classPrivateFieldGet(this,_options).bufferSize*2-seek,_classPrivateFieldGet(this,_chunkSize));_classPrivateFieldSet(this,_chunkSize,_classPrivateFieldGet(this,_chunkSize)-samplesSize);this.format_player.opl.read(_classPrivateFieldGet(this,_samplesBuffer),seek);for(var i=0;i<_classPrivateFieldGet(this,_samplesBuffer).length;i+=2){outputs[0][i>>1]=_classPrivateFieldGet(this,_samplesBuffer)[i];outputs[1][i>>1]=_classPrivateFieldGet(this,_samplesBuffer)[i+1]}}}}]);return WorkletPlayer}();var workletPlayer=WorkletPlayer;var opl3={OPL3:opl3$1,format:{LAA:laa,DRO:dro,IMF:imf,RAW:raw,RAD:rad},MainPlayer:require$$6,WorkletPlayer:workletPlayer};return opl3});
