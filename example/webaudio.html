<!DOCTYPE html>
<html>
<head>
	<title>OPL3</title>
	<script id="opl3" type="text/javascript" src="../dist/opl3.js"></script>
</head>
<body>
    <div class="counter"></div>
    <div>
        <label for="fileUpload">Select a file:</label>
        <input type="file" id="fileUpload" name="fileUpload" accept=".raw,.dro,.laa,.mus,.imf,.rad" onchange="loadFile(this.files)">
    </div>
    <div>
        <button onclick="PlayerStop()">Stop</button>
        <button onclick="player.pause()">Pause</button>
        <button onclick="player.resume()">Resume</button>
    </div>
    <div style="margin-top: 20px">
        <button onclick="TestWorklet()">Test Worklet</button>
        <button onclick="StopWorklet()">Stop Worklet</button>
        <input type="file" accept=".raw,.dro,.laa,.mus,.imf,.rad" onchange="loadFileWorklet(this.files)">
    </div>

    <script type="text/javascript">
        var worklet = null;

        function TestWorklet() {
            var src = document.querySelector("#opl3").src;
            fetch(src).then(script => script.text()).then(async (text) => { 

                var audioContext = new AudioContext();
                await audioContext.audioWorklet.addModule("test-processor.js");

                worklet = new AudioWorkletNode(audioContext, "test-generator", {
                    numberOfOutputs: 1,
                    outputChannelCount : [2]
                });
                // Pass the whole OPL3 module into the worklet
                worklet.port.postMessage({ cmd: 'OPL3', value: text });
                worklet.connect(audioContext.destination);
            });
        }
    
        function StopWorklet() {
            worklet && worklet.disconnect();
        }

        async function loadFileWorklet(files /*: FileList*/) {
            if (files instanceof FileList && files.length) {
                var file = files[0];
                var data /*ArrayBuffer*/ = await FileToArrayBuffer(file);

                worklet && worklet.port.postMessage({ cmd: 'load', value: data });
            }
        }

        var counter = document.querySelector('.counter');
        var player = new OPL3.Player(null, { prebuffer: 3000, volume: 4 });;
        player.on('progress', function() {
            counter.innerHTML = player.position + 'ms / ' + player.length + 'ms';
        });
        player.on('position', function(ms) {
            counter.innerHTML = ms + 'ms / ' + player.length + 'ms';
        });

        function FileToArrayBuffer(file /*: File*/) {
            const fileReader = new FileReader();

            return new Promise((resolve, reject) => {
                fileReader.onerror = () => {
                    fileReader.abort();
                    reject(new Error('Problem parsing input file'))
                };

                fileReader.onload = () => {
                    resolve(fileReader.result);
                };

                fileReader.readAsArrayBuffer(file);
            });
        }

        async function loadFile(files /*: FileList*/) {
            if (files instanceof FileList && files.length) {
                var file = files[0];
                var data /*ArrayBuffer*/ = await FileToArrayBuffer(file);

                player.play(data);
                //worklet && worklet.port.postMessage({ cmd: 'data', value: data });
            }
        }

        function PlayerStop() {
            player.stop();
        }

	</script>
</body>
</html>
